---
phase: 03-engagement-layer
plan: 02
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - supabase/functions/fx-rates-cache/index.ts
  - src/features/currency/types.ts
  - src/features/currency/hooks.ts
  - src/features/export/hooks.ts
  - src/features/expenses/types.ts
  - src/features/expenses/hooks.ts
  - src/features/groups/hooks.ts
  - src/components/expenses/ExpenseCard.tsx
  - app/(app)/groups/[id]/index.tsx
  - app/(app)/expenses/new.tsx
autonomous: true
requirements:
  - CURR-01
  - CURR-02
  - CURR-03
  - CURR-04
  - EXPT-01

must_haves:
  truths:
    - "User can set a base currency for a group from a currency picker"
    - "User can add an expense in a different currency from the group base currency"
    - "The expense form fetches the current FX rate from fx_rates table and stores amount_base_cents at INSERT time"
    - "Both the original amount + currency and the base amount + base currency are shown on every expense card"
    - "FX rates are cached server-side by an hourly pg_cron Edge Function — rates never drift after creation"
    - "User can export a group's expense history as a CSV file opened by the native share sheet"
  artifacts:
    - path: "supabase/functions/fx-rates-cache/index.ts"
      provides: "Hourly Edge Function fetching fawazahmed0 exchange-api and upserting fx_rates table"
    - path: "src/features/currency/types.ts"
      provides: "FxRate, CurrencyOption type definitions"
    - path: "src/features/currency/hooks.ts"
      provides: "useFxRates hook (reads fx_rates table), useGroupCurrency helper, COMMON_CURRENCIES list"
    - path: "src/features/export/hooks.ts"
      provides: "useExportGroupCsv hook — builds RFC 4180 CSV and shares via expo-sharing"
    - path: "src/features/expenses/hooks.ts"
      provides: "createExpenseMutationFn updated to fetch FX rate and compute amount_base_cents at INSERT"
    - path: "src/features/groups/hooks.ts"
      provides: "useUpdateGroupCurrency mutation for CURR-01"
    - path: "src/components/expenses/ExpenseCard.tsx"
      provides: "Dual-currency amount display (original + base) for CURR-04"
    - path: "app/(app)/groups/[id]/index.tsx"
      provides: "Base currency picker section + Export button triggering useExportGroupCsv"
    - path: "app/(app)/expenses/new.tsx"
      provides: "Currency picker on expense form wired to FX rate lookup"
  key_links:
    - from: "app/(app)/expenses/new.tsx"
      to: "fx_rates table"
      via: "useFxRates hook fetches rate at form open; createExpenseMutationFn stores amount_base_cents"
      pattern: "useFxRates|fx_rates"
    - from: "src/features/expenses/hooks.ts createExpenseMutationFn"
      to: "expenses.amount_base_cents"
      via: "Math.round(amount_cents * fxRate) — integer cents, never float"
      pattern: "Math\\.round.*amount_cents.*fxRate|amount_base_cents"
    - from: "src/components/expenses/ExpenseCard.tsx"
      to: "expense.amount_base_cents + expense.base_currency"
      via: "conditional render when expense.currency !== expense.base_currency"
      pattern: "amount_base_cents|base_currency"
    - from: "app/(app)/groups/[id]/index.tsx"
      to: "useExportGroupCsv"
      via: "Export button calls exportGroupCsv(groupId, expenses)"
      pattern: "exportGroupCsv|useExportGroupCsv"
---

<objective>
Deliver multi-currency expense support and CSV export: an hourly Edge Function keeps FX rates fresh in the fx_rates table, the expense form gains a currency picker that snapshots the rate at creation, ExpenseCard renders both original and converted amounts, the group screen gets a base currency picker, and group admins can export full expense history as a CSV file via the native share sheet.

Purpose: Multi-currency covers the traveler use case — the biggest missing feature for international user segments. Export builds power-user trust ("I can always get my data out"). Together they complete Phase 3.
Output: fx-rates-cache Edge Function + currency types/hooks + export hook + UI updates to expense form and expense card and group detail screen
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-engagement-layer/03-RESEARCH.md
@.planning/phases/03-engagement-layer/03-01-SUMMARY.md
</context>

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/features/expenses/types.ts:
```typescript
export interface Expense {
  id: string
  group_id: string
  description: string
  amount_cents: number          // original amount in expense currency (INTEGER cents)
  currency: string              // expense currency code e.g. 'GBP'
  base_currency: string         // group base currency e.g. 'USD'
  fx_rate_at_creation: number   // snapshotted at INSERT, never updated
  amount_base_cents: number     // Math.round(amount_cents * fx_rate_at_creation) — INTEGER
  split_type: SplitType
  payer_id: string | null
  expense_date: string
  category: string | null
  idempotency_key: string
}

export interface CreateExpenseInput {
  group_id: string
  description: string
  amount_cents: number          // in the selected currency
  currency?: string             // default 'USD'
  split_type: SplitType
  payer_member_id: string
  expense_date: string
  category?: string
  splits: Array<{ member_id: string; amount_cents: number }>
  idempotency_key: string
}
```

From src/features/groups/types.ts:
```typescript
export interface Group {
  id: string
  name: string
  base_currency: string         // already exists from Phase 1 schema
}
```

From src/components/expenses/ExpenseCard.tsx (existing):
```typescript
// formatCents currently renders: `$${(cents / 100).toFixed(2)}` — always USD prefix
// Phase 3: must become currency-aware: format with expense.currency symbol
// When expense.currency !== expense.base_currency: show BOTH amounts below the main amount
```

From supabase/functions pattern (from simplify-debts):
```typescript
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
Deno.serve(async (_req: Request) => { ... })
// Service role OK in Edge Functions; NOT in mobile bundle
```

FX rate computation rule (from research + project decisions):
```typescript
// fawazahmed0 CDN endpoint: /v1/currencies/usd.json → { usd: { eur: 0.92, gbp: 0.79, ... } }
// Stored in fx_rates: currency='EUR', rate_to_usd = 1/0.92 (how many USD per 1 EUR)
// Cross-rate conversion from expenseCurrency to baseCurrency:
const fxRate = rates[expenseCurrency].rate_to_usd / rates[baseCurrency].rate_to_usd
const amountBaseCents = Math.round(amountCents * fxRate)
// NEVER use float: (amountCents * fxRate) in floating point is fine only when immediately Math.round'd
```
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: fx-rates-cache Edge Function + currency hooks + FX-aware expense creation</name>
  <files>supabase/functions/fx-rates-cache/index.ts, src/features/currency/types.ts, src/features/currency/hooks.ts, src/features/expenses/hooks.ts</files>
  <action>
**supabase/functions/fx-rates-cache/index.ts** — hourly cron Edge Function (CURR-03):

```typescript
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const FX_API_URL = 'https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/usd.json'

Deno.serve(async (_req: Request) => {
  const supabase = createClient(
    Deno.env.get('SUPABASE_URL')!,
    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
  )

  const res = await fetch(FX_API_URL)
  if (!res.ok) {
    return new Response(JSON.stringify({ error: 'FX fetch failed', status: res.status }), { status: 502 })
  }
  const json = await res.json()
  const usdRates: Record<string, number> = json.usd  // { eur: 0.92, gbp: 0.79, jpy: 149.5, ... }

  // Convert to rate_to_usd: how many USD = 1 unit of currency
  // fawazahmed0 gives USD→OTHER so rate_to_usd = 1 / usdRates[currency]
  const rows = Object.entries(usdRates).map(([currency, usdPerUnit]) => ({
    currency: currency.toUpperCase(),
    rate_to_usd: usdPerUnit === 0 ? 1 : 1 / usdPerUnit,
    fetched_at: new Date().toISOString(),
  }))

  // Upsert all rows — fx_rates table primary key is currency
  const { error } = await supabase
    .from('fx_rates')
    .upsert(rows, { onConflict: 'currency' })

  if (error) {
    return new Response(JSON.stringify({ error: error.message }), { status: 500 })
  }

  return new Response(JSON.stringify({ updated: rows.length }), { status: 200 })
})
```

**src/features/currency/types.ts**:
```typescript
export interface FxRate {
  currency: string      // e.g. 'EUR'
  rate_to_usd: number   // e.g. 1.087 (1 EUR = 1.087 USD)
  fetched_at: string
}

export interface CurrencyOption {
  code: string    // ISO 4217 e.g. 'EUR'
  name: string    // e.g. 'Euro'
  symbol: string  // e.g. '€'
}
```

**src/features/currency/hooks.ts**:

```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import { supabase } from '@/lib/supabase'
import type { FxRate, CurrencyOption } from './types'

// Curated list of ~50 most common currencies (CURR-01/02 picker)
export const COMMON_CURRENCIES: CurrencyOption[] = [
  { code: 'USD', name: 'US Dollar', symbol: '$' },
  { code: 'EUR', name: 'Euro', symbol: '€' },
  { code: 'GBP', name: 'British Pound', symbol: '£' },
  { code: 'JPY', name: 'Japanese Yen', symbol: '¥' },
  { code: 'CAD', name: 'Canadian Dollar', symbol: 'CA$' },
  { code: 'AUD', name: 'Australian Dollar', symbol: 'A$' },
  { code: 'CHF', name: 'Swiss Franc', symbol: 'Fr' },
  { code: 'CNY', name: 'Chinese Yuan', symbol: '¥' },
  { code: 'INR', name: 'Indian Rupee', symbol: '₹' },
  { code: 'MXN', name: 'Mexican Peso', symbol: '$' },
  { code: 'BRL', name: 'Brazilian Real', symbol: 'R$' },
  { code: 'KRW', name: 'South Korean Won', symbol: '₩' },
  { code: 'SGD', name: 'Singapore Dollar', symbol: 'S$' },
  { code: 'HKD', name: 'Hong Kong Dollar', symbol: 'HK$' },
  { code: 'NOK', name: 'Norwegian Krone', symbol: 'kr' },
  { code: 'SEK', name: 'Swedish Krona', symbol: 'kr' },
  { code: 'DKK', name: 'Danish Krone', symbol: 'kr' },
  { code: 'NZD', name: 'New Zealand Dollar', symbol: 'NZ$' },
  { code: 'ZAR', name: 'South African Rand', symbol: 'R' },
  { code: 'AED', name: 'UAE Dirham', symbol: 'د.إ' },
  { code: 'SAR', name: 'Saudi Riyal', symbol: '﷼' },
  { code: 'THB', name: 'Thai Baht', symbol: '฿' },
  { code: 'TRY', name: 'Turkish Lira', symbol: '₺' },
  { code: 'PLN', name: 'Polish Zloty', symbol: 'zł' },
  { code: 'CZK', name: 'Czech Koruna', symbol: 'Kč' },
  { code: 'HUF', name: 'Hungarian Forint', symbol: 'Ft' },
  { code: 'RON', name: 'Romanian Leu', symbol: 'lei' },
  { code: 'IDR', name: 'Indonesian Rupiah', symbol: 'Rp' },
  { code: 'MYR', name: 'Malaysian Ringgit', symbol: 'RM' },
  { code: 'PHP', name: 'Philippine Peso', symbol: '₱' },
  { code: 'TWD', name: 'Taiwan Dollar', symbol: 'NT$' },
  { code: 'VND', name: 'Vietnamese Dong', symbol: '₫' },
  { code: 'EGP', name: 'Egyptian Pound', symbol: '£' },
  { code: 'NGN', name: 'Nigerian Naira', symbol: '₦' },
  { code: 'KES', name: 'Kenyan Shilling', symbol: 'KSh' },
  { code: 'GHS', name: 'Ghanaian Cedi', symbol: 'GH₵' },
  { code: 'PKR', name: 'Pakistani Rupee', symbol: '₨' },
  { code: 'BDT', name: 'Bangladeshi Taka', symbol: '৳' },
  { code: 'CLP', name: 'Chilean Peso', symbol: '$' },
  { code: 'COP', name: 'Colombian Peso', symbol: '$' },
  { code: 'PEN', name: 'Peruvian Sol', symbol: 'S/' },
  { code: 'ARS', name: 'Argentine Peso', symbol: '$' },
  { code: 'ILS', name: 'Israeli Shekel', symbol: '₪' },
  { code: 'QAR', name: 'Qatari Riyal', symbol: '﷼' },
  { code: 'KWD', name: 'Kuwaiti Dinar', symbol: 'د.ك' },
  { code: 'MAD', name: 'Moroccan Dirham', symbol: 'د.م.' },
  { code: 'UAH', name: 'Ukrainian Hryvnia', symbol: '₴' },
  { code: 'CZK', name: 'Czech Koruna', symbol: 'Kč' },
  { code: 'HRK', name: 'Croatian Kuna', symbol: 'kn' },
  { code: 'RSD', name: 'Serbian Dinar', symbol: 'din' },
]

/**
 * Fetch all FX rates from the fx_rates table (populated hourly by fx-rates-cache Edge Function).
 * staleTime 30 min — rates are only updated hourly by cron; no need to refetch frequently.
 */
export function useFxRates() {
  return useQuery<Record<string, number>>({
    queryKey: ['fx_rates'],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('fx_rates')
        .select('currency, rate_to_usd')
      if (error) throw error
      const rateMap: Record<string, number> = {}
      ;(data as FxRate[]).forEach((r) => { rateMap[r.currency] = r.rate_to_usd })
      return rateMap
    },
    staleTime: 30 * 60 * 1000,  // 30 minutes
  })
}

/**
 * Compute amount_base_cents from amount_cents using the rate map.
 * Returns { amountBaseCents, fxRate }.
 * Uses Math.round for integer cents — never float arithmetic on monetary values.
 */
export function computeBaseCents(
  amountCents: number,
  expenseCurrency: string,
  baseCurrency: string,
  rates: Record<string, number>  // currency → rate_to_usd
): { amountBaseCents: number; fxRate: number } {
  if (expenseCurrency === baseCurrency) return { amountBaseCents: amountCents, fxRate: 1.0 }
  const expenseRate = rates[expenseCurrency] ?? 1
  const baseRate = rates[baseCurrency] ?? 1
  const fxRate = expenseRate / baseRate
  const amountBaseCents = Math.round(amountCents * fxRate)
  return { amountBaseCents, fxRate }
}
```

**src/features/expenses/hooks.ts — update `createExpenseMutationFn`:**

The existing function hardcodes `base_currency: currency` and `fx_rate_at_creation: 1.0`. Update it to:
1. Accept `base_currency` in `CreateExpenseInput` (add optional field, default to `currency`)
2. Accept `fx_rate_at_creation` in `CreateExpenseInput` (add optional field, default to `1.0`)
3. Accept `amount_base_cents` in `CreateExpenseInput` (add optional field, default to `amount_cents`)

Also update the `CreateExpenseInput` type in `src/features/expenses/types.ts`:
```typescript
export interface CreateExpenseInput {
  // ... existing fields ...
  base_currency?: string          // group base currency; defaults to currency if omitted
  fx_rate_at_creation?: number    // snapshotted FX rate; defaults to 1.0 if omitted
  amount_base_cents?: number      // computed base amount; defaults to amount_cents if omitted
}
```

In `createExpenseMutationFn`, update the expense INSERT to use these new optional fields:
```typescript
const {
  base_currency = currency,
  fx_rate_at_creation = 1.0,
  amount_base_cents = amount_cents,
  // ... rest of existing destructuring ...
} = input

// In the supabase insert:
await supabase.from('expenses').insert({
  // ... existing fields ...
  base_currency,
  fx_rate_at_creation,
  amount_base_cents,
})
```

This is a purely additive change — existing callers (with no base_currency/fx_rate fields) default to the current behavior.
  </action>
  <verify>
    <automated>npx tsc --noEmit 2>&1 | grep -E "currency/|export/|expenses/hooks" | head -10 || echo "PASS: no TS errors in new currency files"</automated>
  </verify>
  <done>supabase/functions/fx-rates-cache/index.ts exists and fetches from fawazahmed0 CDN; currency types and hooks files exist with COMMON_CURRENCIES list, useFxRates hook, and computeBaseCents helper; CreateExpenseInput updated with optional base_currency/fx_rate_at_creation/amount_base_cents fields; TypeScript compiles</done>
</task>

<task type="auto">
  <name>Task 2: Currency picker UI + ExpenseCard dual amounts + CSV export</name>
  <files>src/features/export/hooks.ts, src/features/groups/hooks.ts, src/components/expenses/ExpenseCard.tsx, app/(app)/groups/[id]/index.tsx, app/(app)/expenses/new.tsx</files>
  <action>
**src/features/export/hooks.ts** — EXPT-01 CSV export:

```typescript
import * as FileSystem from 'expo-file-system'
import * as Sharing from 'expo-sharing'
import type { Expense } from '@/features/expenses/types'

export async function exportGroupCsv(groupId: string, expenses: Expense[]): Promise<void> {
  const BOM = '\uFEFF'  // UTF-8 BOM for Excel/Numbers compatibility
  const header = 'Date,Description,Amount,Currency,Base Amount,Base Currency,Split Type,Category\n'

  const rows = expenses.map((e) => {
    const desc = `"${(e.description ?? '').replace(/"/g, '""')}"`
    const cat = `"${(e.category ?? '').replace(/"/g, '""')}"`
    return [
      e.expense_date,
      desc,
      (e.amount_cents / 100).toFixed(2),
      e.currency,
      (e.amount_base_cents / 100).toFixed(2),
      e.base_currency,
      e.split_type,
      cat,
    ].join(',')
  })

  const csv = BOM + header + rows.join('\n')
  const fileUri = `${FileSystem.cacheDirectory}expenses-${groupId}-${Date.now()}.csv`

  await FileSystem.writeAsStringAsync(fileUri, csv, {
    encoding: FileSystem.EncodingType.UTF8,
  })

  const isAvailable = await Sharing.isAvailableAsync()
  if (isAvailable) {
    await Sharing.shareAsync(fileUri, {
      mimeType: 'text/csv',
      dialogTitle: 'Export Expenses',
      UTI: 'public.comma-separated-values-text',  // iOS UTI for CSV
    })
  }
}
```

**src/features/groups/hooks.ts** — add `useUpdateGroupCurrency` mutation (CURR-01):

Add to the existing hooks file:
```typescript
export function useUpdateGroupCurrency() {
  const queryClient = useQueryClient()
  return useMutation({
    mutationFn: async ({ groupId, currency }: { groupId: string; currency: string }) => {
      const { error } = await supabase
        .from('groups')
        .update({ base_currency: currency })
        .eq('id', groupId)
      if (error) throw error
    },
    onSuccess: (_data, { groupId }) => {
      queryClient.invalidateQueries({ queryKey: ['groups', groupId] })
      queryClient.invalidateQueries({ queryKey: ['groups'] })
    },
  })
}
```

**src/components/expenses/ExpenseCard.tsx** — update `formatCents` and amount display for CURR-04:

Replace the existing hardcoded `formatCents` function with a currency-aware formatter:
```typescript
function formatAmount(cents: number, currencyCode: string): string {
  // Simple formatting: use currency code prefix for non-USD, $ for USD
  // For a production app we'd use Intl.NumberFormat — for MVP, code prefix is clear enough
  const amount = (cents / 100).toFixed(2)
  return currencyCode === 'USD' ? `$${amount}` : `${currencyCode} ${amount}`
}
```

In the `return` JSX of `ExpenseCard`, replace the single amount `Text` with:
```typescript
<View className="items-end">
  <Text className="text-white font-bold text-base">
    {formatAmount(expense.amount_cents, expense.currency)}
  </Text>
  {expense.currency !== expense.base_currency && (
    <Text className="text-white/40 text-xs mt-0.5">
      ≈ {formatAmount(expense.amount_base_cents, expense.base_currency)}
    </Text>
  )}
</View>
```

Replace the existing `<Text className="text-white font-bold text-base">{formatCents(expense.amount_cents)}</Text>` with the above `<View>`.

**app/(app)/groups/[id]/index.tsx** — add base currency picker + export button (CURR-01, EXPT-01):

1. Import `useUpdateGroupCurrency` from `@/features/groups/hooks`
2. Import `useFxRates`, `COMMON_CURRENCIES` from `@/features/currency/hooks`
3. Import `exportGroupCsv` from `@/features/export/hooks`
4. Add a `useState<boolean>` for `showCurrencyPicker` (modal visibility)
5. Add a "Base currency" row showing `group.base_currency` — tap opens a `Modal` with a `FlatList` of `COMMON_CURRENCIES` filtered by a search `TextInput`
6. On currency selection: call `updateGroupCurrency({ groupId: id, currency: selectedCode })`, close modal
7. Add an "Export CSV" `TouchableOpacity` button below the expense list — calls `exportGroupCsv(id, expenses ?? [])` in an async handler wrapped in try/catch with an Alert on error
8. Currency picker modal styling: dark background (`bg-dark-bg`), items as `TouchableOpacity` rows, each showing `${currency.symbol} ${currency.code} — ${currency.name}`

The Modal and currency list should be placed after the existing members/balance content but within the `ScrollView`.

**app/(app)/expenses/new.tsx** — add expense currency picker (CURR-02, CURR-03):

1. Import `useFxRates`, `COMMON_CURRENCIES`, `computeBaseCents` from `@/features/currency/hooks`
2. Add `useState<string>` for `expenseCurrency` (default to `group?.base_currency ?? 'USD'`)
3. Call `useFxRates()` to get the rate map
4. Add a currency picker row on the form (similar to category picker): tap opens an inline currency list modal
5. When the user submits the form, compute FX values before calling `createExpense`:
```typescript
const rates = fxRates ?? {}
const baseCurrency = groupData?.group?.base_currency ?? expenseCurrency
const { amountBaseCents, fxRate } = computeBaseCents(amountCents, expenseCurrency, baseCurrency, rates)

createExpense.mutate({
  // ... existing fields ...
  currency: expenseCurrency,
  base_currency: baseCurrency,
  fx_rate_at_creation: fxRate,
  amount_base_cents: amountBaseCents,
})
```
6. If `fxRates` is undefined (table empty — first run before cron executes), fall back gracefully: `fxRate = 1.0`, `amountBaseCents = amountCents`, `base_currency = expenseCurrency`. Do not block the form.

Note: In direct (1-on-1) mode where `groupData` is undefined, use `expenseCurrency` as both currency and base_currency (fxRate = 1.0).
  </action>
  <verify>
    <automated>npx tsc --noEmit 2>&1 | grep -E "export/hooks|groups/hooks|ExpenseCard|groups/\[id\]|expenses/new" | head -10 || echo "PASS: no TS errors in UI files"</automated>
  </verify>
  <done>src/features/export/hooks.ts exports exportGroupCsv with RFC 4180 escaping and UTF-8 BOM; useUpdateGroupCurrency added to groups/hooks.ts; ExpenseCard shows dual amounts when currency !== base_currency; group detail screen has currency picker modal and Export CSV button; expense form has currency picker with FX lookup; TypeScript compiles without errors</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` — no errors across all modified files
- `ls supabase/functions/fx-rates-cache/index.ts` — Edge Function exists
- `grep "amount_base_cents" src/components/expenses/ExpenseCard.tsx` — dual amount display present
- `grep "exportGroupCsv" app/(app)/groups/[id]/index.tsx` — export wired to group screen
- `grep "expenseCurrency" app/(app)/expenses/new.tsx` — currency picker in expense form
- `grep "base_currency" src/features/expenses/hooks.ts` — createExpenseMutationFn uses new fields
</verification>

<success_criteria>
- supabase/functions/fx-rates-cache/index.ts fetches fawazahmed0 CDN and upserts to fx_rates table (depends on migration in 03-01)
- src/features/currency/types.ts and hooks.ts exist with FxRate type, COMMON_CURRENCIES list (50 currencies), useFxRates hook, computeBaseCents function
- src/features/export/hooks.ts exports exportGroupCsv with BOM, RFC 4180 quoting, expo-file-system + expo-sharing
- CreateExpenseInput accepts optional base_currency, fx_rate_at_creation, amount_base_cents
- createExpenseMutationFn stores snapshotted FX rate at INSERT time — never recalculated
- ExpenseCard renders original amount + secondary converted amount when currencies differ
- Group detail screen has base currency picker and Export CSV button wired
- Expense form has currency picker with FX rate lookup and graceful fallback if fx_rates table is empty
- TypeScript compiles without errors across all modified files
</success_criteria>

<output>
After completion, create `.planning/phases/03-engagement-layer/03-02-SUMMARY.md`
</output>
