---
phase: 01.5-google-oauth-inserted
plan: "01"
subsystem: auth
tags: [google-oauth, expo-auth-session, expo-web-browser, supabase-oauth, deep-linking]

# Dependency graph
requires:
  - phase: 01-foundation
    provides: useSession/useSignIn/useSignUp/useSignOut hooks, Supabase client, expo-linking already installed, nexus:// app scheme in app.json

provides:
  - useSignInWithGoogle hook (signInWithOAuth + WebBrowser.openAuthSessionAsync pattern)
  - createSessionFromUrl helper for cold-start deep link OAuth token extraction
  - DB migration patching handle_new_user trigger with COALESCE for full_name/display_name and avatar_url
  - "Continue with Google" button with divider on both sign-in and sign-up screens
  - WebBrowser warmup/cooldown and Linking.useURL() cold-start handler on both screens

affects: [phase-2-core-expense-loop, any-future-auth-work]

# Tech tracking
tech-stack:
  added:
    - expo-auth-session@~55.0.6
    - expo-web-browser@~55.0.9
    - expo-crypto@~55.0.8
  patterns:
    - signInWithOAuth with skipBrowserRedirect:true + WebBrowser.openAuthSessionAsync for Expo OAuth
    - createSessionFromUrl extracts access_token/refresh_token from redirect URL via QueryParams.getQueryParams
    - WebBrowser.maybeCompleteAuthSession() at module level in hooks.ts (required for web platform)
    - Linking.useURL() cold-start handler in both auth screens guards against Android process restart on OAuth redirect
    - WebBrowser.warmUpAsync/coolDownAsync in useEffect for Chrome Custom Tabs pre-warming on Android

key-files:
  created:
    - supabase/migrations/20260228000002_google_oauth.sql
  modified:
    - src/features/auth/hooks.ts
    - app/(auth)/sign-in.tsx
    - app/(auth)/sign-up.tsx
    - package.json
    - pnpm-lock.yaml

key-decisions:
  - "makeRedirectUri() reads nexus scheme from app.json automatically — register nexus://** (wildcard) in Supabase Auth URL Configuration to allow all paths"
  - "skipBrowserRedirect:true is required when using WebBrowser.openAuthSessionAsync — omitting it causes Supabase to open its own browser which bypasses the Expo flow"
  - "CREATE OR REPLACE FUNCTION preserves existing on_auth_user_created trigger binding — no DROP/RECREATE of trigger needed for migration"
  - "supabase db push requires manual supabase link --project-ref <ref> (known blocker from STATE.md) — migration file is correct but manual apply required"
  - "variant=secondary on Button (not outline which doesn't exist) renders bg-dark-surface border border-dark-border — visually distinct from primary CTA"

patterns-established:
  - "Expo OAuth pattern: signInWithOAuth(skipBrowserRedirect:true) → openAuthSessionAsync → createSessionFromUrl on success"
  - "Cold-start guard: Linking.useURL() useEffect alongside WebBrowser warmup in every screen that handles OAuth redirects"

requirements-completed: [AUTH-06, AUTH-07]

# Metrics
duration: 12min
completed: 2026-02-28
---

# Phase 1.5 Plan 01: Google OAuth Summary

**Google OAuth added as second sign-in path via expo-auth-session + WebBrowser, with DB trigger patched to populate avatar_url and COALESCE full_name/display_name for new OAuth users**

## Performance

- **Duration:** ~12 min
- **Started:** 2026-02-28T09:34:56Z
- **Completed:** 2026-02-28T09:46:56Z
- **Tasks:** 2 (+ 1 checkpoint auto-approved)
- **Files modified:** 6

## Accomplishments

- Installed expo-auth-session, expo-web-browser, expo-crypto (SDK 55 compatible via npx expo install)
- Added useSignInWithGoogle hook and createSessionFromUrl helper to hooks.ts additively — all 6 existing auth hooks untouched
- Wrote supabase/migrations/20260228000002_google_oauth.sql with CREATE OR REPLACE to patch handle_new_user trigger for Google OAuth metadata (COALESCE display_name/full_name, avatar_url)
- Wired "Continue with Google" button + divider + WebBrowser warmup + cold-start Linking handler into both sign-in.tsx and sign-up.tsx without touching existing form logic

## Task Commits

Each task was committed atomically:

1. **Task 1: Install packages, add useSignInWithGoogle hook, and write DB migration** - `ad387da` (feat)
2. **Task 2: Wire Google button and cold-start handler into sign-in and sign-up screens** - `0410755` (feat)

**Plan metadata:** (final docs commit — see below)

## Files Created/Modified

- `src/features/auth/hooks.ts` - Added makeRedirectUri/QueryParams/WebBrowser imports, maybeCompleteAuthSession() at module level, redirectTo constant, createSessionFromUrl helper, useSignInWithGoogle hook
- `supabase/migrations/20260228000002_google_oauth.sql` - CREATE OR REPLACE handle_new_user with COALESCE(display_name, full_name) and avatar_url
- `app/(auth)/sign-in.tsx` - Added useEffect warmup, Linking.useURL() cold-start handler, useSignInWithGoogle, divider JSX, Google button (variant=secondary)
- `app/(auth)/sign-up.tsx` - Same additions as sign-in.tsx; all existing form logic and nav links unchanged
- `package.json` - Added expo-auth-session, expo-web-browser, expo-crypto
- `pnpm-lock.yaml` - Updated lockfile after package install

## Decisions Made

- Used `makeRedirectUri()` with nexus scheme (reads from app.json automatically) — requires `nexus://**` wildcard in Supabase Auth URL Configuration Redirect URLs allowlist
- `skipBrowserRedirect: true` is required in signInWithOAuth options when using WebBrowser.openAuthSessionAsync (otherwise Supabase auto-opens browser and bypasses Expo flow)
- `CREATE OR REPLACE FUNCTION` approach in migration preserves the existing `on_auth_user_created` trigger binding — no trigger drop/recreate needed
- Button `variant="secondary"` used (not `"outline"` which doesn't exist in Button component) — renders dark surface with border, visually distinct from primary button

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

- `supabase db push` requires `supabase link --project-ref <ref>` first — this is a pre-documented blocker in STATE.md. The migration file is written correctly; the db push must be run manually after linking the project. This was noted in the plan itself as a known manual step.

## User Setup Required

Before the OAuth flow will work:

1. **Supabase Dashboard — Redirect URL allowlist:** Go to Auth → URL Configuration → Redirect URLs and add `nexus://**` (wildcard covers all paths makeRedirectUri() may append)
2. **Apply migration manually:** Run `supabase link --project-ref <your-project-ref>` then `supabase db push` to apply `20260228000002_google_oauth.sql` to the hosted project
3. **Google Cloud Console** (if not already done): Ensure `https://<project-ref>.supabase.co/auth/v1/callback` is in Authorized Redirect URIs (noted as already configured per planning context)

## Auto-Mode Checkpoint

- **checkpoint:human-verify** (Task 3) — Auto-approved (auto_advance: true). Manual verification of Google OAuth end-to-end flow can be done by running `npx expo start --dev-client` and following the steps in the plan's checkpoint.

## Next Phase Readiness

- Google OAuth client code is complete and TypeScript-clean
- DB migration is written and ready to apply (requires manual supabase link + db push)
- Supabase Redirect URL allowlist must be updated before testing
- Phase 2 (Core Expense Loop) can begin — auth foundation (Phase 1 + Phase 1.5) is now complete

## Self-Check: PASSED

All files found:
- FOUND: src/features/auth/hooks.ts
- FOUND: supabase/migrations/20260228000002_google_oauth.sql
- FOUND: app/(auth)/sign-in.tsx
- FOUND: app/(auth)/sign-up.tsx
- FOUND: .planning/phases/01.5-google-oauth-inserted/1.5-01-SUMMARY.md

All task commits found:
- FOUND: ad387da (feat: install OAuth packages, hook, migration)
- FOUND: 0410755 (feat: wire Google button and cold-start handler)

---
*Phase: 01.5-google-oauth-inserted*
*Completed: 2026-02-28*
