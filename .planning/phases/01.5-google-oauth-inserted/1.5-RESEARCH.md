# Phase 1.5: Google OAuth [INSERTED] - Research

**Researched:** 2026-02-28
**Domain:** Supabase OAuth + Expo deep linking (expo-auth-session, expo-web-browser, supabase.auth.signInWithOAuth)
**Confidence:** HIGH (official Supabase docs + Expo docs verified; account-linking behavior confirmed via official identity-linking guide)

---

<phase_requirements>
## Phase Requirements

| ID | Description | Research Support |
|----|-------------|-----------------|
| AUTH-06 | User can sign in (or create an account) with Google OAuth — one tap, no password required | signInWithOAuth + WebBrowser.openAuthSessionAsync pattern documented; expo-auth-session makeRedirectUri generates correct deep-link URI |
| AUTH-07 | A Google sign-in using an email that already exists as an email/password account is automatically linked — no duplicate user | Supabase automatic identity linking is built-in and enabled by default; requires verified email on existing account (standard signup flow satisfies this) |
</phase_requirements>

---

## Summary

Phase 1.5 adds Google OAuth as a second sign-in path alongside the existing email/password flow. The entire implementation uses `supabase.auth.signInWithOAuth` (the same Supabase client already in the project) combined with `expo-auth-session`'s `makeRedirectUri` and `expo-web-browser`'s `WebBrowser.openAuthSessionAsync`. No additional auth SDK is required — this is pure Supabase + two Expo packages.

The OAuth flow works as follows: the app calls `signInWithOAuth` with `skipBrowserRedirect: true` to get the Google authorization URL, opens it in the system browser via `WebBrowser.openAuthSessionAsync`, the user authenticates with Google, Google redirects to Supabase's callback URL which attaches tokens to the deep-link redirect URI (`nexus://...`), the OS hands the deep link back to the app, and the app extracts tokens from the URL query parameters and calls `supabase.auth.setSession`. The `onAuthStateChange` listener in `useSession` fires automatically, routing the user into the `(app)` stack. Zero changes to session management or the existing `useSession` hook are required.

AUTH-07 (account linking) is handled entirely by Supabase's server-side automatic identity linking. When a Google OAuth sign-in uses an email that already has an email/password account, Supabase automatically links the new Google identity to the existing user — no duplicate user is created. This requires no client code; it is a built-in Supabase Auth behavior conditional on the existing account having a verified email (which Supabase email/password signup with email confirmation satisfies). The DB trigger `handle_new_user` fires only on first user creation (`INSERT` into `auth.users`), not on identity linking, so it needs a patch only for the display_name/avatar_url population path for new Google-only users.

**Primary recommendation:** Use `supabase.auth.signInWithOAuth` + `expo-web-browser` + `expo-auth-session`. Implement as a single new hook `useSignInWithGoogle` in `src/features/auth/hooks.ts`. Patch the DB trigger via a new migration to also read `full_name` and `avatar_url` from `raw_user_meta_data` for OAuth-created users.

---

## Standard Stack

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| expo-auth-session | ~55.0.6 | `makeRedirectUri()` — generates the platform-correct deep-link redirect URI | Official Expo SDK; handles dev/prod/Expo Go URI differences automatically |
| expo-web-browser | ~55.0.5 | `WebBrowser.openAuthSessionAsync()` — opens the Google auth URL in system browser; captures redirect | Official Expo SDK; required for OAuth on Android dev client |
| @supabase/supabase-js | already installed (^2.98.0) | `supabase.auth.signInWithOAuth` + `supabase.auth.setSession` | Already in the project; signInWithOAuth is the correct Supabase method for web-browser OAuth |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| expo-auth-session/build/QueryParams | bundled with expo-auth-session | `QueryParams.getQueryParams(url)` — extracts access_token and refresh_token from the redirect URL | Always used in `createSessionFromUrl` helper |
| expo-linking | already installed (~55.0.7) | `Linking.useURL()` — catches the deep-link URL if the app was cold-started via the OAuth redirect | Already in project; needed for cold-start OAuth callback handling |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| expo-auth-session + expo-web-browser | @react-native-google-signin/google-signin | Native Google SDK gives faster UX but requires Android SHA-1 fingerprint, Google Services file, separate client ID, and native build changes. The web-browser approach works with the existing EAS dev client setup with zero native configuration beyond the scheme. Not worth the complexity for this insertion phase. |
| signInWithOAuth (web browser flow) | Google Identity Services native SDK | Same as above. Web browser OAuth is the Supabase-recommended approach for Expo and matches existing architecture. |

**Installation:**
```bash
npx expo install expo-auth-session expo-web-browser expo-crypto
```

Note: `expo-crypto` is a peer dependency of `expo-auth-session` and must be installed alongside it. `expo-linking` is already installed.

---

## Architecture Patterns

### Recommended Project Structure

No new directories needed. Changes are additive to existing structure:

```
src/features/auth/
├── hooks.ts          # ADD: useSignInWithGoogle hook (additive — no existing hook modified)
├── types.ts          # No changes needed
supabase/migrations/
└── 20260228000002_google_oauth.sql   # NEW: patch handle_new_user for OAuth metadata
app/(auth)/
├── sign-in.tsx       # ADD: "Continue with Google" button
└── sign-up.tsx       # ADD: "Continue with Google" button (secondary CTA)
app.json              # Verify scheme is set — "nexus" already configured
lib/supabase.ts       # NO CHANGES (detectSessionInUrl: false is already correct)
```

### Pattern 1: signInWithOAuth with skipBrowserRedirect

**What:** Get the Google authorization URL from Supabase, then manually open it in the system browser. `skipBrowserRedirect: true` prevents the Supabase SDK from attempting to redirect in the current environment (which doesn't work on mobile) — you handle the browser opening manually.

**When to use:** Every time the user taps "Continue with Google". This is the only supported pattern for Expo OAuth.

**Example:**
```typescript
// Source: https://supabase.com/docs/guides/auth/native-mobile-deep-linking
import { makeRedirectUri } from 'expo-auth-session'
import * as QueryParams from 'expo-auth-session/build/QueryParams'
import * as WebBrowser from 'expo-web-browser'
import * as Linking from 'expo-linking'
import { supabase } from '@/lib/supabase'

WebBrowser.maybeCompleteAuthSession()  // Must be called at module level

const redirectTo = makeRedirectUri()  // Reads scheme from app.json automatically
// On Android dev client with scheme "nexus": produces "nexus://..."

const createSessionFromUrl = async (url: string) => {
  const { params, errorCode } = QueryParams.getQueryParams(url)
  if (errorCode) throw new Error(errorCode)
  const { access_token, refresh_token } = params
  if (!access_token) return
  const { data, error } = await supabase.auth.setSession({ access_token, refresh_token })
  if (error) throw error
  return data.session
}

export function useSignInWithGoogle() {
  return useMutation({
    mutationFn: async () => {
      const { data, error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo,
          skipBrowserRedirect: true,
        },
      })
      if (error) throw error

      const res = await WebBrowser.openAuthSessionAsync(data?.url ?? '', redirectTo)
      if (res.type === 'success') {
        await createSessionFromUrl(res.url)
      }
    },
  })
}
```

### Pattern 2: Cold-Start Deep Link Handling

**What:** If the user's app was closed and the OS opens it via the OAuth redirect deep link, `Linking.useURL()` captures the URL on mount. This is the fallback for the case where `WebBrowser.openAuthSessionAsync` did not capture the redirect in-band.

**When to use:** Add to the root layout or auth screen alongside the hook.

**Example:**
```typescript
// Source: https://supabase.com/docs/guides/auth/native-mobile-deep-linking
import * as Linking from 'expo-linking'

// In a component or the auth screen:
const url = Linking.useURL()
useEffect(() => {
  if (url) createSessionFromUrl(url)
}, [url])
```

### Pattern 3: DB Trigger Patch for OAuth Metadata

**What:** The existing `handle_new_user` trigger only reads `display_name` from `raw_user_meta_data` (the key set during email/password signup). For Google OAuth users, the trigger fires on their first sign-in, but Google provides `full_name` and `avatar_url` as the keys.

**When to use:** A new migration must patch the trigger to use `COALESCE` across both key names, so it works for both email/password and Google OAuth new users.

**Example:**
```sql
-- Source: Supabase community docs, discussion #4047, #3216
-- Migration: 20260228000002_google_oauth.sql
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = ''
AS $$
BEGIN
  INSERT INTO public.profiles (id, display_name, avatar_url)
  VALUES (
    new.id,
    COALESCE(
      new.raw_user_meta_data ->> 'display_name',   -- email/password signup path
      new.raw_user_meta_data ->> 'full_name'        -- Google OAuth path
    ),
    new.raw_user_meta_data ->> 'avatar_url'         -- Google OAuth provides this key
  );
  RETURN new;
END;
$$;
```

Google's exact keys in `raw_user_meta_data`: `full_name` and `avatar_url`. Both confirmed via Supabase community discussion #4047 (multiple users verified the actual JSON structure). The `picture` key appears only inside the nested `identities[].identity_data` object, not the top-level `raw_user_meta_data`.

### Pattern 4: Android WebBrowser Warmup (Performance)

**What:** `WebBrowser.warmUpAsync()` pre-warms Chrome Custom Tabs on Android, reducing the time the browser takes to open. `coolDownAsync()` cleans up in the effect cleanup.

**When to use:** In a `useEffect` in the auth screens that show the Google button.

**Example:**
```typescript
// Source: Supabase community + Expo authentication guide
useEffect(() => {
  WebBrowser.warmUpAsync()
  return () => { WebBrowser.coolDownAsync() }
}, [])
```

### Anti-Patterns to Avoid

- **Changing `detectSessionInUrl: false` in supabase.ts:** This setting is CORRECT for React Native. The OAuth callback is handled manually via `createSessionFromUrl` + `setSession`. Do NOT change it to `true` — that would break session handling on mobile.
- **Using `Linking.createURL` instead of `makeRedirectUri`:** `makeRedirectUri` from expo-auth-session handles the development/production/Expo Go environment differences automatically. `Linking.createURL` is a lower-level alternative that requires manual environment detection.
- **Using the Google native SDK (@react-native-google-signin):** Requires Android SHA-1 fingerprint, google-services.json, and a native build reconfiguration. The web-browser approach achieves the same result with the existing EAS setup.
- **Calling `createSessionFromUrl` without checking `access_token`:** If the user cancels the flow, the redirect URL may arrive without tokens. Always guard with `if (!access_token) return`.
- **Adding `avatar_url` column to profiles migration retroactively:** The `profiles` table already has `avatar_url TEXT`. Do not redefine it — only the trigger function needs patching.

---

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Generating the OAuth redirect URI | Custom URI construction logic | `makeRedirectUri()` from expo-auth-session | Handles dev client vs Expo Go vs production differences; handles triple-slash schemes; reads app.json scheme automatically |
| Extracting tokens from redirect URL | Manual URL parsing with `new URL()` or regex | `QueryParams.getQueryParams(url)` from expo-auth-session | Handles URL encoding, hash fragments vs query params, error code extraction; battle-tested across all Expo environments |
| Opening Google auth in the browser | `Linking.openURL()` | `WebBrowser.openAuthSessionAsync()` | `openAuthSessionAsync` knows the redirect URI and can intercept the redirect back to the app; `openURL` cannot capture the return URL |
| Account de-duplication logic | Custom duplicate-user check before OAuth | Supabase automatic identity linking | Supabase Auth handles identity linking server-side; client-side duplicate checks create race conditions and are unnecessary |
| Token refresh for OAuth sessions | Custom refresh timer | `supabase.auth.autoRefreshToken: true` (already set) | Already configured in the existing supabase.ts; works identically for OAuth and email/password sessions |

**Key insight:** The entire OAuth flow has exactly two non-trivial steps: (1) get the URL from Supabase, open it in a browser; (2) extract tokens from the redirect URL, call setSession. Everything else is already handled — by Supabase, by the existing `useSession`/`onAuthStateChange` subscription, and by expo-auth-session's utilities.

---

## Common Pitfalls

### Pitfall 1: Redirect URL Not Registered in Supabase Dashboard

**What goes wrong:** The OAuth flow completes in the browser but Supabase rejects the redirect, returning an error. The user never lands back in the app.

**Why it happens:** Supabase validates the `redirectTo` URL against an allowlist in the dashboard. The `nexus://` URI generated by `makeRedirectUri()` must be explicitly added to Supabase Auth → URL Configuration → Redirect URLs.

**How to avoid:** Add `nexus://**` (wildcard) to the Redirect URLs in the Supabase dashboard before testing. This is a one-time manual step — not codified in migrations.

**Warning signs:** `WebBrowser.openAuthSessionAsync` returns `type: "cancel"` or `type: "dismiss"` instead of `type: "success"`.

---

### Pitfall 2: Google Cloud Console Redirect URI Mismatch

**What goes wrong:** Google rejects the OAuth request with `redirect_uri_mismatch` error in the browser.

**Why it happens:** Google Cloud Console requires the Supabase callback URL (`https://<project-ref>.supabase.co/auth/v1/callback`) to be listed in the OAuth 2.0 client's Authorized redirect URIs. The mobile deep link (`nexus://`) does NOT go into Google Console — only the Supabase server-side callback URL does.

**How to avoid:** In Google Cloud Console, create a Web Application OAuth 2.0 client (not Android). Add `https://<project-ref>.supabase.co/auth/v1/callback` to Authorized redirect URIs. Put the resulting Client ID and Client Secret in the Supabase dashboard's Google provider settings.

**Warning signs:** The system browser shows a Google error page immediately after the user taps "Continue with Google".

---

### Pitfall 3: Handle_new_user Trigger Only Runs on INSERT, Not on Identity Link

**What goes wrong:** An existing email/password user links their Google account (AUTH-07). The trigger does NOT fire again — it only fires on `AFTER INSERT ON auth.users`. So `avatar_url` and `display_name` are NOT updated from Google metadata for linked accounts.

**Why it happens:** Automatic identity linking does not create a new `auth.users` row — it adds a row to `auth.identities` for the existing user. The `handle_new_user` trigger on `auth.users` INSERT does not fire.

**How to avoid:** This is expected and acceptable behavior. The existing `display_name` and `avatar_url` on the profile (set during email/password signup) are preserved. The success criterion says "correctly populates display_name and avatar_url from Google metadata for **new OAuth users**" — this applies only to brand-new users whose first sign-in is Google. For linked accounts, the profile already has data.

**Warning signs:** None — this is correct behavior, not a bug. Document it clearly in the plan.

---

### Pitfall 4: `onAuthStateChange` Async Operations Block `setSession`

**What goes wrong:** `setSession` call appears to hang or never resolves. The user is authenticated on the server but the app remains on the auth screen.

**Why it happens:** The `onAuthStateChange` listener in `useSession` (and any other subscribers) fires synchronously during `setSession`. If a subscriber performs blocking async operations, it can prevent the `setSession` promise from resolving.

**How to avoid:** The existing `useSession` hook subscribes to `onAuthStateChange` and only calls `setSession` on local state — this is non-blocking. Ensure no new async database operations are added inside auth state listeners in this phase.

**Warning signs:** Google button spins indefinitely after the browser closes; no navigation to the `(app)` stack.

---

### Pitfall 5: Cold Start OAuth Redirect Not Handled

**What goes wrong:** On Android, if Chrome closes and reopens the app via deep link (rather than returning to the existing app instance), `WebBrowser.openAuthSessionAsync` returns `type: "cancel"` but the deep link arrives via `Linking.useURL()`. Without the `Linking.useURL()` handler, the session is never established.

**Why it happens:** Android can cold-start the app via an intent when the deep link fires. The `openAuthSessionAsync` return value is not delivered in this case.

**How to avoid:** Always implement both paths: (1) handle `res.type === "success"` from `openAuthSessionAsync` AND (2) listen for `Linking.useURL()` in the auth screen or root layout.

**Warning signs:** OAuth works fine in development but fails intermittently on real Android devices, especially with Chrome.

---

### Pitfall 6: `scheme` in app.json Is Already "nexus" — That Is the Redirect URI Prefix

**What goes wrong:** Developer assumes the scheme should be `com.owe.app` (the package name) and creates a mismatch between what `makeRedirectUri()` generates and what is registered in Supabase dashboard.

**Why it happens:** The app.json `scheme` is `"nexus"` (not `"com.owe.app"`). `makeRedirectUri()` generates `nexus://` URIs. The Supabase allowlist must use `nexus://**`, not `com.owe.app://**`.

**How to avoid:** Verify `makeRedirectUri()` output by logging it in development before configuring the Supabase allowlist. Register `nexus://**` in Supabase → Auth → URL Configuration → Redirect URLs.

**Warning signs:** `redirect_uri_mismatch` errors from Supabase (not Google).

---

## Code Examples

Verified patterns from official sources:

### Complete useSignInWithGoogle Hook
```typescript
// Source: https://supabase.com/docs/guides/auth/native-mobile-deep-linking (adapted for project patterns)
import { useMutation } from '@tanstack/react-query'
import { makeRedirectUri } from 'expo-auth-session'
import * as QueryParams from 'expo-auth-session/build/QueryParams'
import * as WebBrowser from 'expo-web-browser'
import { supabase } from '@/lib/supabase'

WebBrowser.maybeCompleteAuthSession()

const redirectTo = makeRedirectUri()

const createSessionFromUrl = async (url: string) => {
  const { params, errorCode } = QueryParams.getQueryParams(url)
  if (errorCode) throw new Error(errorCode)
  const { access_token, refresh_token } = params
  if (!access_token) return  // User cancelled — no tokens
  const { data, error } = await supabase.auth.setSession({ access_token, refresh_token })
  if (error) throw error
  return data.session
}

// AUTH-06: Google OAuth sign-in (also creates account for new users)
export function useSignInWithGoogle() {
  return useMutation({
    mutationFn: async () => {
      // Step 1: Get the Google authorization URL from Supabase
      const { data, error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo,
          skipBrowserRedirect: true,  // We open the browser manually
        },
      })
      if (error) throw error

      // Step 2: Open Google auth in system browser; wait for redirect back
      const res = await WebBrowser.openAuthSessionAsync(data?.url ?? '', redirectTo)

      // Step 3: If browser returned successfully, extract tokens and set session
      if (res.type === 'success') {
        await createSessionFromUrl(res.url)
      }
      // If res.type === 'cancel' or 'dismiss': user cancelled, do nothing
    },
  })
}

// Export for use in auth screens to handle cold-start deep links
export { createSessionFromUrl }
```

### Cold-Start Handler in Auth Screen
```typescript
// Source: https://supabase.com/docs/guides/auth/native-mobile-deep-linking
import * as Linking from 'expo-linking'
import { createSessionFromUrl } from '@/features/auth/hooks'

// In the sign-in screen component:
const url = Linking.useURL()
useEffect(() => {
  if (url) createSessionFromUrl(url)
}, [url])
```

### Android Browser Warmup Pattern
```typescript
// Source: Supabase community guides + Expo documentation
import * as WebBrowser from 'expo-web-browser'

// In sign-in and sign-up screens:
useEffect(() => {
  WebBrowser.warmUpAsync()
  return () => { WebBrowser.coolDownAsync() }
}, [])
```

### DB Trigger Migration (New Migration File)
```sql
-- Migration: 20260228000002_google_oauth.sql
-- Patch handle_new_user to populate avatar_url for Google OAuth new users
-- Google provides: raw_user_meta_data->>'full_name' and raw_user_meta_data->>'avatar_url'
-- Email/password provides: raw_user_meta_data->>'display_name' (set in useSignUp options.data)

CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = ''
AS $$
BEGIN
  INSERT INTO public.profiles (id, display_name, avatar_url)
  VALUES (
    new.id,
    COALESCE(
      new.raw_user_meta_data ->> 'display_name',
      new.raw_user_meta_data ->> 'full_name'
    ),
    new.raw_user_meta_data ->> 'avatar_url'
  );
  RETURN new;
END;
$$;
-- Note: CREATE OR REPLACE preserves the existing trigger binding (on_auth_user_created).
-- No DROP/RECREATE of the trigger itself is needed.
```

### Google Button UI Component Pattern
```tsx
// To be added to app/(auth)/sign-in.tsx and sign-up.tsx
// Reuses existing Button component; visual separation with divider line

<View className="my-6 flex-row items-center gap-3">
  <View className="flex-1 h-px bg-white/10" />
  <Text className="text-white/40 text-sm">or</Text>
  <View className="flex-1 h-px bg-white/10" />
</View>

<Button
  title={isPendingGoogle ? 'Opening Google...' : 'Continue with Google'}
  onPress={() => signInWithGoogle()}
  disabled={isPendingGoogle}
  variant="outline"  // Assumes Button supports a variant prop; otherwise style directly
/>
```

---

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| `@react-native-google-signin/google-signin` native SDK | `supabase.auth.signInWithOAuth` + expo-web-browser | 2022-2024 | No SHA-1 fingerprint or google-services.json required; works with existing EAS dev client; Supabase handles token exchange server-side |
| Manual `Linking.createURL()` for redirect URI | `makeRedirectUri()` from expo-auth-session | 2022 | Handles dev/prod/Expo Go environment differences automatically |
| `AsyncStorage` for auth storage | `expo-sqlite/localStorage` polyfill | 2024 (already implemented in Phase 1) | No change needed — the existing supabase.ts setup works identically for OAuth sessions |
| `detectSessionInUrl: true` for web OAuth | `detectSessionInUrl: false` + manual `setSession` | 2022 (for RN) | Already correct in project's supabase.ts — do NOT change this setting |

**Deprecated/outdated:**
- `supabase.auth.signIn({ provider: 'google' })`: Old supabase-js v1 API. Current is `signInWithOAuth`.
- `expo-auth-session`'s `useAuthRequest` + `promptAsync` combination: Works but requires more boilerplate than the `signInWithOAuth` + `openAuthSessionAsync` pattern. The Supabase-native approach is simpler and recommended.
- `WebBrowser.openBrowserAsync()`: Does not return the redirect URL. Must use `openAuthSessionAsync` for OAuth.

---

## Configuration Checklist

Items that CANNOT be done in code — manual dashboard/console steps:

### Supabase Dashboard
1. **Auth → Providers → Google**: Enable Google provider. Enter Web OAuth Client ID and Client Secret from Google Cloud Console.
2. **Auth → URL Configuration → Redirect URLs**: Add `nexus://**` to allow the mobile deep link scheme.

### Google Cloud Console
1. **Create OAuth 2.0 Client**: Type must be "Web application" (not Android, not iOS).
2. **Authorized redirect URIs**: Add `https://<project-ref>.supabase.co/auth/v1/callback`. This is the Supabase server callback — NOT the `nexus://` mobile URI.
3. **Copy Client ID and Client Secret**: These go into the Supabase dashboard Google provider settings.

---

## Open Questions

1. **iOS support**
   - What we know: Multiple sources note Supabase does not currently support `signInWithOAuth` for Google on iOS (Apple requires Sign in with Apple as the primary social login when publishing to App Store). The REQUIREMENTS.md also lists "Apple Sign-In" as explicitly out of scope.
   - What's unclear: Whether the web-browser OAuth flow works on iOS even if App Store rules don't require it (it may technically function for development testing purposes).
   - Recommendation: Implement with Android as the target (matching the project's primary platform). Test on iOS in dev; document that iOS production App Store submission would require Sign in with Apple alongside Google. This is already deferred per REQUIREMENTS.md Out of Scope table.

2. **`makeRedirectUri()` output in EAS dev client**
   - What we know: `makeRedirectUri()` reads `scheme` from app.json and generates `nexus://` on a dev client. In Expo Go it would generate `exp://...`. The project uses EAS dev client, not Expo Go.
   - What's unclear: The exact path component appended (e.g., `nexus://` vs `nexus:///`). This should be logged in the first run.
   - Recommendation: Log `makeRedirectUri()` output during initial implementation and verify it matches what is registered in Supabase dashboard. Use `nexus://**` (wildcard) in the Supabase allowlist to handle any path variation.

3. **Profile update for linked accounts**
   - What we know: The `handle_new_user` trigger only fires on INSERT into `auth.users`. For AUTH-07 (linking), the trigger does NOT run — the existing profile is preserved.
   - What's unclear: Whether the product wants to update `avatar_url` and `display_name` from Google metadata for users who link their existing account via Google for the first time.
   - Recommendation: Out of scope for Phase 1.5. The success criterion says "for new OAuth users" — linked users already have profile data. A future phase can add a profile sync hook if needed.

---

## Sources

### Primary (HIGH confidence)
- `https://supabase.com/docs/guides/auth/native-mobile-deep-linking` — Complete OAuth deep linking pattern for Expo: signInWithOAuth, skipBrowserRedirect, openAuthSessionAsync, createSessionFromUrl, makeRedirectUri
- `https://supabase.com/docs/guides/auth/auth-identity-linking` — Automatic identity linking behavior: built-in, requires verified email, no client code needed
- `https://docs.expo.dev/versions/latest/sdk/auth-session/` — makeRedirectUri API, expo-auth-session package details, SDK 55 version (55.0.6)

### Secondary (MEDIUM confidence)
- `https://github.com/orgs/supabase/discussions/4047` — Confirmed Google OAuth exact keys in raw_user_meta_data: `full_name` and `avatar_url` (multiple users verified actual JSON structure)
- `https://supabase.com/docs/guides/auth/auth-identity-linking` — Verified automatic linking is default behavior; manual linking is separate opt-in beta feature
- `https://supabase.com/docs/guides/auth/quickstarts/react-native` — Confirmed `detectSessionInUrl: false` is correct for React Native; confirmed setSession pattern
- Expo authentication guide (docs.expo.dev/guides/authentication) — warmUpAsync/coolDownAsync pattern for Android; expo-auth-session + expo-web-browser separation

### Tertiary (LOW confidence)
- Multiple community guides (SpiroKit, ReadWriteExercise, Medium/Erdem Gonul) — warmUpAsync pattern; general implementation flow. All consistent with official docs, elevating confidence. Not directly verifiable via WebFetch.

---

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH — expo-auth-session 55.0.6 and expo-web-browser confirmed from Expo official docs; supabase.auth.signInWithOAuth is the documented Supabase method
- Architecture: HIGH — The signInWithOAuth + openAuthSessionAsync + createSessionFromUrl pattern is documented verbatim in Supabase's official deep-linking guide
- Automatic identity linking (AUTH-07): HIGH — Confirmed as built-in Supabase behavior in official identity-linking docs; no client code required
- DB trigger key names (full_name, avatar_url): MEDIUM-HIGH — Confirmed by multiple community sources and cross-referenced; exact values should be verified against actual Google OAuth response on first test run
- Pitfalls: HIGH — Derived from official docs, known GitHub issues, and architecture analysis of existing code

**Research date:** 2026-02-28
**Valid until:** 2026-03-30 (stable Supabase auth + Expo SDK 55; recheck if Expo SDK or Supabase JS version changes)
