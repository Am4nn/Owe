---
phase: 07-bug-fixes
plan: "01"
title: Bug Fixes â€” All Known Issues from Device Testing
status: in_progress
requirements_completed: []
discovered: 2026-03-02
tested_on: Physical Android device (Samsung) + web browser (Expo dev server)
---

# Phase 7 Plan 01: Bug Fixes

## Context

Bugs discovered over two physical device + web test sessions on 2026-03-02.

**Session 1** â€” first run on physical Android device. Testing partially blocked by BUG-01
(GRANT permissions missing). After that fix, BUG-02 through BUG-06 surfaced.

**Session 2** â€” after applying round-1 fixes, further bugs on mobile and web surfaced
(BUG-07 through BUG-11).

Legend: âœ… CONFIRMED FIXED by user | ðŸ”§ FIX APPLIED â€” pending verification | ðŸ”´ OPEN

---

## Bug Registry

### BUG-01 â€” GRANT permissions missing on all tables âœ… CONFIRMED FIXED
**Symptom:** `permission denied for table group_members / profiles` (HTTP 403, PG 42501)
**Root cause:** Zero GRANT statements in any migration. PostgreSQL requires both a table-level
GRANT and a matching RLS policy. Only policies existed, no GRANTs.
**Fix:** Migration `20260302000007_grant_table_permissions.sql` â€” GRANT SELECT/INSERT/UPDATE/DELETE
on all 12 app tables to the `authenticated` role.
**Commit:** `8f4d75c`

---

### BUG-02 â€” Add Expense error on mobile ðŸ”§ FIX APPLIED â€” pending verification
**Symptom (session 1):** Tapping "Add expense" did nothing â€” no error, no navigation.
**Symptom (session 2):** Expense IS created now but app throws `Error: Property 'crypto' doesn't
exist` (visible after reload).
**Root causes:**
1. Zod schema had `payer_member_id: z.string().uuid('Select a payer')` â€” blocked silent submit in direct mode. **Fixed** in commit `842a61a` (made optional).
2. `crypto.randomUUID()` is not available on React Native / Hermes. **Fixed** in commit `fa07e73` (replaced with `ExpoCrypto.randomUUID()` from the installed `expo-crypto` package).
**Files:** `app/(app)/expenses/new.tsx`
**Commits:** `842a61a`, `fa07e73`

---

### BUG-03 â€” `useGroup('')` fires invalid UUID API request âœ… CONFIRMED FIXED
**Symptom:** `GET /rest/v1/groups?select=*&id=eq.` â†’ 400 `22P02 invalid input syntax for type uuid: ""`
**Root cause:** `useGroup(groupId ?? '')` called with empty string in direct mode.
**Fix:** Added `enabled: !!groupId` to the `useGroup` query in `src/features/groups/hooks.ts`.
**Commit:** `842a61a`

---

### BUG-04 â€” No way to create a group (FAB missing "New Group") ðŸ”§ FIX APPLIED â€” pending verification
**Symptom:** No "New Group" button anywhere. `app/(app)/groups/new.tsx` exists but unreachable.
**Root cause:** `ExpandableFAB.tsx` was missing the child button.
**Fix:** Added "New Group" at offsetY -160; shifted Transfer to -240, Scan Receipt to -320.
**File:** `src/components/ui/ExpandableFAB.tsx`
**Commit:** `842a61a`
**Note:** User reported "No visible change yet" â€” may require a full rebuild, not just Metro reload.

---

### BUG-05 â€” expo-notifications sound 'default' console error âœ… CONFIRMED FIXED
**Symptom:** "expo-notifications: Custom sound 'default' not found in native app."
**Root cause:** `sound: 'default'` in `setNotificationChannelAsync` is treated as a custom file
name, not the system default.
**Fix:** Removed the `sound` field entirely from the channel config.
**File:** `src/features/notifications/hooks.ts`
**Commit:** `842a61a`

---

### BUG-06 â€” expo-notifications APIs crash on web ðŸ”§ FIX APPLIED â€” pending verification
**Symptom:** Web console: "ExpoNotifications is not available on web".
**Root cause:** `Notifications.setNotificationHandler(...)` ran at module-load time unconditionally.
**Fix:** Wrapped module-level handler and all calls in `registerPushToken` /
`useNotificationDeepLink` with `Platform.OS !== 'web'` guards.
**File:** `src/features/notifications/hooks.ts`
**Commit:** `842a61a`

---

### BUG-07 â€” `crypto.randomUUID()` crashes on Android ðŸ”§ FIX APPLIED â€” pending verification
**Symptom:** After recording a settlement, app throws `Error: Property 'crypto' doesn't exist`.
**Root cause:** React Native / Hermes does not expose the global `crypto` Web API.
**Fix:** Replaced `crypto.randomUUID()` with `ExpoCrypto.randomUUID()` from `expo-crypto`.
**Files:** `app/(app)/expenses/new.tsx`, `app/(app)/settlement/new.tsx`
**Commit:** `fa07e73`

---

### BUG-08 â€” GestureHandlerRootView missing â†’ crash on group tap ðŸ”§ FIX APPLIED â€” pending verification
**Symptom:** Tapping a group on the dashboard throws: "GestureDetector must be used as a
descendant of GestureHandlerRootView."
**Root cause:** `react-native-gesture-handler` requires `GestureHandlerRootView` at the app root.
It was never added.
**Fix:** Wrapped `RootLayout` return value with `<GestureHandlerRootView style={{ flex: 1 }}>`.
**File:** `app/_layout.tsx`
**Commit:** `fa07e73`

---

### BUG-09 â€” WebBrowser.warmUpAsync / coolDownAsync crash on web ðŸ”§ FIX APPLIED â€” pending verification
**Symptom:** Web console: "The method or property WebBrowser.warmUpAsync is not available on web."
**Root cause:** Chrome Custom Tabs warm-up is a native-only Android API called unconditionally.
**Fix:** Added `if (Platform.OS === 'web') return` inside both `useEffect` hooks.
**Files:** `app/(auth)/sign-in.tsx`, `app/(auth)/sign-up.tsx`
**Commit:** `fa07e73`

---

### BUG-10 â€” Uncontrolled â†’ controlled input warning on web ðŸ”§ FIX APPLIED â€” pending verification
**Symptom:** Web console: "A component is changing an uncontrolled input to be controlled."
**Root cause:** `useForm` in auth screens had no `defaultValues` â€” fields started as `undefined`
(uncontrolled on web DOM) and became strings on first keypress (controlled).
**Fix:** Added explicit `defaultValues` to both sign-in and sign-up forms.
**Files:** `app/(auth)/sign-in.tsx`, `app/(auth)/sign-up.tsx`
**Commit:** `fa07e73`

---

### BUG-11 â€” NativeWind dark mode 'media' warning on web ðŸ”§ FIX APPLIED â€” pending verification
**Symptom:** Web console: "Cannot manually set color scheme, as dark mode is type 'media'.
Please use StyleSheet.setFlag('darkMode', 'class')."
**Root cause:** NativeWind defaults to `media` dark mode strategy on web and warns when trying
to force programmatic dark mode.
**Fix:**
1. Added `darkMode: 'class'` to `tailwind.config.js`.
2. Added `StyleSheet.setFlag?.('darkMode', 'class')` in `app/_layout.tsx` behind a
   `Platform.OS === 'web'` guard.
**Files:** `tailwind.config.js`, `app/_layout.tsx`
**Commit:** `fa07e73`

---

### BUG-12 â€” Alert.prompt crashes on Android and web âœ… MODAL CONFIRMED (send blocked by BUG-12b)
**Symptom:** "Alert.default.prompt is not a function" when tapping "Invite by email" on web
(and Android, which also lacks Alert.prompt).
**Root cause:** `Alert.prompt` is iOS-only. The invite handler in
`app/(app)/groups/[id]/index.tsx` called it unconditionally.
**Fix:** Replaced `Alert.prompt` with a cross-platform slide-up `Modal` + `TextInput` following
the same pattern already used in the screen for the currency and reminder-delay pickers.
Added `showInviteModal` / `inviteEmail` state; split handler into `handleInvite` (open modal)
and `handleSendInvite` (submit).
**File:** `app/(app)/groups/[id]/index.tsx`
**Commit:** `97d54fe`

---

### BUG-12b â€” "Send Invite" permission denied for table users ðŸ”§ FIX APPLIED â€” pending verification
**Symptom:** After BUG-12 modal fix, tapping "Send Invite" returned `Error: permission denied
for table users`.
**Root cause:** The `group_invites` SELECT policy contained `SELECT email FROM auth.users WHERE
id = auth.uid()`. The `authenticated` role has no access to `auth.users`. This fires on every
`.insert().select()` call because RETURNING triggers the SELECT policy.
**Fix:** Migration `20260302000009_fix_invites_rls.sql` â€” dropped old policy and recreated with
`invited_email = auth.email()` (Supabase built-in, no table access needed).
**Commit:** `c46b50c`

---

### BUG-14 â€” Leave group "nothing happens" on web ðŸ”§ FIX APPLIED â€” pending verification
**Symptom:** Tapping "Leave Group" on web does nothing. Works fine on mobile.
**Root cause:** `Alert.alert` with multiple buttons on web is implemented via `window.confirm`,
which is silently blocked by most browsers (popup blocker or sandboxed iframe context).
The confirmation dialog never appears, so the `onPress` callback never fires.
**Fix:** Replaced `Alert.alert` confirmation with a cross-platform transparent overlay `Modal`
(same pattern as invite and delay picker modals). `handleLeave` now opens `showLeaveModal`;
`handleConfirmLeave` fires the actual mutation.
**File:** `app/(app)/groups/[id]/index.tsx`
**Commit:** `c319544`

---

### BUG-13 â€” Leave group FK violation âœ… CONFIRMED FIXED (user reported)
**Symptom:** "update or delete on table group_members violates foreign key constraint
`expenses_player_id_fkey` on table expenses".
**Root cause:** `useLeaveGroup` was doing a `DELETE` on the `group_members` row. Three FK
constraints reference `group_members(id)` without `ON DELETE CASCADE`:
`expenses.payer_id`, `expense_splits.member_id`, `settlements.payer_id/payee_id`.
Deleting the row violates all of them.
**Fix:**
- Migration `20260302000008_leave_group_rls.sql`: adds `UPDATE` RLS policy
  `members_can_unlink_themselves` (`WITH CHECK (user_id IS NULL)`) so users can set their
  own `user_id = NULL`.
- `useLeaveGroup` now calls `.update({ user_id: null })` instead of `.delete()`.
  Converting to named-only preserves all historical data; display_name stays intact.
  PostgreSQL's `UNIQUE(group_id, user_id)` allows multiple NULLs.
**Files:** `supabase/migrations/20260302000008_leave_group_rls.sql`, `src/features/groups/hooks.ts`
**Commit:** `a6bb286`

---

### BUG-15 â€” Invite success not shown on web + misleading copy ðŸ”§ FIX APPLIED â€” pending verification
**Symptom (web):** After sending invite, the modal closes but no success confirmation appears.
**Symptom (all):** Success message said "Invite sent" implying an email was dispatched â€” but
no email delivery mechanism exists in the codebase.
**Root causes:**
1. `Alert.alert('Invite sent', ...)` after closing the modal uses `window.alert` on web,
   which is blocked in sandboxed contexts.
2. No Edge Function / webhook exists to send email â€” invite is only saved to `group_invites`.
**Fix:**
- Added `inviteSent` state to the modal. On success, shows inline `âœ“ Invite saved!` with
  accurate message ("will be added when they sign up") and auto-dismisses after 2.5s.
- Removed the post-close `Alert.alert` entirely on both platforms.
- Added `(Email delivery coming soon)` note to set correct user expectations.
**Known gap:** Actual email delivery requires a Supabase Edge Function (deferred).
**File:** `app/(app)/groups/[id]/index.tsx`
**Commit:** `41e2b8c`

---

## Commits

| Commit | Description |
|--------|-------------|
| `8f4d75c` | Migration: GRANT permissions on all 12 tables (BUG-01) |
| `842a61a` | Round 1 fixes: BUG-02 (partial), BUG-03, BUG-04, BUG-05, BUG-06 |
| `fa07e73` | Round 2 fixes: BUG-02 (crypto), BUG-07 through BUG-11 |
| `97d54fe` | BUG-12: replace Alert.prompt with cross-platform invite modal |
| `a6bb286` | BUG-13: fix leave group FK violation (UPDATE user_id=null + RLS policy) |
| `c319544` | BUG-14: replace Alert.alert leave confirmation with cross-platform modal |
| `41e2b8c` | BUG-15: fix invite success UX on web + honest copy (no email delivery yet) |

---

## Success Criteria

1. [ ] Tapping "Add expense" in direct mode creates the expense with no crash after reload
2. âœ… No 400/22P02 API error in Metro logs when opening the expense form
3. [ ] Dashboard FAB shows "New Group" â€” tapping it opens the create group form
4. âœ… No "Custom sound 'default' not found" console error on device
5. [ ] No expo-notifications crash on web
6. [ ] No `crypto` crash after adding an expense or recording a settlement
7. [ ] Tapping a group no longer crashes with GestureHandlerRootView error
8. [ ] No WebBrowser.warmUpAsync warnings on web sign-in/sign-up
9. [ ] No uncontrolled-input React warning on web auth forms
10. [ ] No NativeWind dark mode 'media' warning on web
11. [ ] "Invite by email" modal opens without crash
12. [ ] "Send Invite" succeeds without permission error
13. âœ… Leave group succeeds without FK violation
14. [ ] Leave group confirmation modal works on web (no window.confirm)
15. [ ] Invite success shows inline âœ“ confirmation on both mobile and web
16. ðŸ”´ KNOWN GAP: No email is actually sent for invites â€” requires an Edge Function (deferred to Phase 8 or later)
