---
phase: 05-schema-notification-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260301000006_add_settlement_note.sql
  - supabase/functions/push-notify/index.ts
autonomous: false
gap_closure: true
requirements:
  - SETL-01
  - SETL-03
  - NOTF-01

must_haves:
  truths:
    - "A note entered on the settlement form is saved to the settlements table (not silently dropped)"
    - "Settlement history displays the saved note when one was provided"
    - "Tapping an expense push notification opens /expenses/[id] — not a 404"
    - "Settlement push notifications continue to deep-link correctly (unchanged)"
  artifacts:
    - path: "supabase/migrations/20260301000006_add_settlement_note.sql"
      provides: "ADD COLUMN note TEXT to settlements table — nullable, no DEFAULT"
      contains: "ALTER TABLE public.settlements ADD COLUMN note TEXT"
    - path: "supabase/functions/push-notify/index.ts"
      provides: "Fixed expense deep-link URL — /expenses/${record.id}"
      contains: "dataUrl = `/expenses/${record.id}`"
  key_links:
    - from: "supabase/migrations/20260301000006_add_settlement_note.sql"
      to: "public.settlements.note"
      via: "ALTER TABLE ADD COLUMN"
      pattern: "ADD COLUMN note TEXT"
    - from: "supabase/functions/push-notify/index.ts"
      to: "app/(app)/expenses/[id]/index.tsx"
      via: "router.push(url) in useNotificationDeepLink — url comes verbatim from push payload"
      pattern: "dataUrl = `/expenses/\\$\\{record\\.id\\}`"
---

<objective>
Close two independent integration gaps discovered during the v1.0 audit.

Gap 1 (SETL-01, SETL-03): The `settlements` table has no `note` column. PostgREST silently drops
the `note` field on every INSERT even though `useCreateSettlement` sends it, the TypeScript type
declares it, the settlement form collects it, and the settlement history screen renders it. Adding
`ALTER TABLE public.settlements ADD COLUMN note TEXT` is the only change required — all four
application layers already handle `note` correctly.

Gap 2 (NOTF-01): `push-notify/index.ts` line 50 sets `dataUrl = /groups/${record.group_id}/expenses/${record.id}`.
The Expo Router expense screen lives at `app/(app)/expenses/[id]/index.tsx` — route `/expenses/[id]`
— because `(app)` is a route group (parentheses = organizational, not a URL segment). The deep-link
handler calls `router.push(url)` verbatim with no transformation, so every expense notification tap
navigates to a 404. The fix is a one-line string change on line 50. Line 62 (settlement deep-link)
is already correct — do NOT touch it.

Both fixes are surgical. No new dependencies, no new components, no client-side code changes.

Output: One new migration file + one Edge Function line change.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-schema-notification-fixes/05-RESEARCH.md
</context>

<interfaces>
<!-- Existing code that already handles note — no changes needed to these files -->

From src/features/settlements/types.ts:
```typescript
// note field already declared in the Settlement interface
note: string | null
```

From src/features/settlements/hooks.ts (lines 27-36):
```typescript
// note already sent in the INSERT — currently silently dropped by PostgREST
.insert({
  group_id,
  payer_id: payer_member_id,
  payee_id: payee_member_id,
  amount_cents,
  currency,
  note: note ?? null,        // PostgREST will persist this once column exists
  idempotency_key,
  settled_at: new Date().toISOString(),
})
```

From app/(app)/groups/[id]/settlements.tsx (lines 44-48):
```tsx
// note already rendered conditionally — works once column exists and data is persisted
{item.note ? (
  <Text className="text-white/50 text-sm mt-0.5" numberOfLines={2}>
    {item.note}
  </Text>
) : null}
```

From supabase/functions/push-notify/index.ts (line 50 — BROKEN):
```typescript
// BROKEN: navigates to a 404 — /groups/:groupId/expenses/:id does not exist in Expo Router
dataUrl = `/groups/${record.group_id}/expenses/${record.id}`
```

From supabase/functions/push-notify/index.ts (line 62 — CORRECT, do not touch):
```typescript
// CORRECT: settlements screen IS at app/(app)/groups/[id]/settlements.tsx → /groups/[id]/settlements
dataUrl = `/groups/${record.group_id}/settlements`
```

From src/features/notifications/hooks.ts — useNotificationDeepLink:
```typescript
// URL from push payload is used VERBATIM — no prefix, no transformation
const url = response?.notification?.request?.content?.data?.url
if (url && typeof url === 'string') {
  router.push(url as never)
}
```

Expo Router file structure (confirms correct route):
```
app/(app)/expenses/[id]/index.tsx
         ^^^^^^^^
         (app) is a route GROUP — does NOT appear in the navigable URL.
         Navigable URL: /expenses/[id]
```
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Add migration to persist settlement note field</name>
  <files>supabase/migrations/20260301000006_add_settlement_note.sql</files>
  <action>
    Create a new file at `supabase/migrations/20260301000006_add_settlement_note.sql` with exactly
    the following content:

    ```sql
    -- Migration: 20260301000006_add_settlement_note.sql
    -- Phase 5: Schema & Notification Fixes
    -- Gap: settlements table had no note column — the note field sent by useCreateSettlement
    --      was silently dropped by PostgREST on every INSERT.
    -- Fix: Add nullable TEXT column. Existing rows get NULL implicitly (correct — they have no note).
    --      No DEFAULT needed. No NOT NULL constraint — matches TypeScript type `note: string | null`.
    --      No RLS change — existing policies cover all columns in the table automatically.
    --      No index needed — note is display-only, never filtered or sorted.
    --      Do NOT modify 20260227000001_foundation.sql — it is already applied; editing it would
    --      cause supabase db push to skip the change (migration tracked by content hash).

    ALTER TABLE public.settlements ADD COLUMN note TEXT;
    ```

    IMPORTANT constraints:
    - Do NOT add `NOT NULL` — that would fail immediately because existing rows have no note value.
    - Do NOT add `DEFAULT ''` — NULL is the correct representation of "no note provided", matching
      the hook which sends `note: note ?? null`.
    - Do NOT modify any existing migration file.
    - Do NOT touch any TypeScript files — the type, hook, form, and history screen already handle
      `note` correctly. The only gap was the missing DB column.
  </action>
  <verify>
    <automated>grep -c "ALTER TABLE public.settlements ADD COLUMN note TEXT" "supabase/migrations/20260301000006_add_settlement_note.sql"</automated>
  </verify>
  <done>
    File `supabase/migrations/20260301000006_add_settlement_note.sql` exists and contains
    `ALTER TABLE public.settlements ADD COLUMN note TEXT` with no NOT NULL or DEFAULT clause.
    No TypeScript files were modified.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix expense push notification deep-link URL</name>
  <files>supabase/functions/push-notify/index.ts</files>
  <action>
    Edit `supabase/functions/push-notify/index.ts` — change line 50 only.

    Find this exact line (the broken URL):
    ```typescript
    dataUrl = `/groups/${record.group_id}/expenses/${record.id}`
    ```

    Replace it with (the correct URL):
    ```typescript
    dataUrl = `/expenses/${record.id}`
    ```

    CRITICAL: Change ONLY line 50. Do NOT touch any other line in the file.
    Specifically, do NOT change line 62 which sets the settlement deep-link:
    ```typescript
    dataUrl = `/groups/${record.group_id}/settlements`
    ```
    That line is already correct — the settlements screen IS at `/groups/[id]/settlements`.

    Why this fixes NOTF-01:
    - The Expo Router expense screen file is `app/(app)/expenses/[id]/index.tsx`
    - `(app)` is a route group — parenthesised segments are organizational and do NOT appear in URLs
    - The navigable URL is `/expenses/[id]`, not `/groups/:groupId/expenses/:id`
    - `useNotificationDeepLink` calls `router.push(url)` verbatim — no URL transformation occurs
    - After this fix, tapping an expense notification navigates to the correct screen
  </action>
  <verify>
    <automated>grep -c "dataUrl = \`/expenses/\${record.id}\`" "supabase/functions/push-notify/index.ts" && grep -c "dataUrl = \`/groups/\${record.group_id}/expenses/\${record.id}\`" "supabase/functions/push-notify/index.ts"</automated>
  </verify>
  <done>
    `supabase/functions/push-notify/index.ts` line 50 now reads `dataUrl = \`/expenses/\${record.id}\``.
    The broken form `/groups/${record.group_id}/expenses/${record.id}` no longer appears in the file.
    Line 62 (settlement deep-link) is unchanged.
    No other lines were modified.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    1. Migration `20260301000006_add_settlement_note.sql`: adds `note TEXT` column to the
       `settlements` table so the note entered on the settlement form is persisted and shown in
       settlement history.
    2. Push-notify Edge Function fix: changes the expense deep-link from
       `/groups/:groupId/expenses/:id` (404) to `/expenses/:id` (correct Expo Router route) so
       tapping an expense push notification opens the expense detail screen.
  </what-built>
  <how-to-verify>
    Apply the migration and redeploy the Edge Function first:
    ```bash
    supabase db push
    supabase functions deploy push-notify
    ```

    Then verify the two flows:

    **Flow 1 — Settlement note persisted and displayed (SETL-01, SETL-03):**
    1. Open a group and navigate to the settlement flow (e.g., Simplified Debts -> Settle)
    2. Enter an amount AND a note (e.g., "Venmo reimbursement")
    3. Submit the settlement
    4. Navigate to the group's Settlement History tab
    5. Expected: The settlement row appears and the note "Venmo reimbursement" is visible below
       the amount and member names
    6. Confirm the note is not blank/missing

    **Flow 2 — Expense notification deep-link works (NOTF-01):**
    1. Have two devices (or a device + simulator) both signed in and in the same group
    2. On Device A, add a new expense to the group
    3. On Device B, a push notification should arrive (may take a few seconds)
    4. Tap the notification on Device B
    5. Expected: The app opens directly to the expense detail screen for the new expense
    6. Confirm you do NOT see a 404 / blank screen / navigation error

    Note: Push notification testing requires real devices or a simulator with push entitlements.
    If the push environment is not available, verify the fix by inspecting the deployed Edge
    Function logs in the Supabase Dashboard to confirm the `dataUrl` value sent is `/expenses/[id]`.

    Confirm both flows pass before typing "approved".
  </how-to-verify>
  <resume-signal>Type "approved" if both flows work (or describe which step failed and what error appeared)</resume-signal>
</task>

</tasks>

<verification>
Static verification (automated, run after Task 1 and Task 2):
- `supabase/migrations/20260301000006_add_settlement_note.sql` exists
- Migration contains `ALTER TABLE public.settlements ADD COLUMN note TEXT`
- Migration does NOT contain `NOT NULL` on the note column
- `supabase/functions/push-notify/index.ts` contains `dataUrl = \`/expenses/\${record.id}\``
- `supabase/functions/push-notify/index.ts` does NOT contain `/groups/${record.group_id}/expenses/`
- `supabase/functions/push-notify/index.ts` still contains `/groups/${record.group_id}/settlements` (settlement deep-link unchanged)
- No TypeScript source files were modified
- TypeScript still compiles: `npx tsc --noEmit` exits 0

Runtime verification (human required — see checkpoint above):
- Settlement note entered in form is visible in settlement history (SETL-01, SETL-03)
- Tapping an expense push notification opens the expense detail screen, not a 404 (NOTF-01)
</verification>

<success_criteria>
- `supabase/migrations/20260301000006_add_settlement_note.sql` exists with the correct ALTER TABLE statement
- `supabase/functions/push-notify/index.ts` line 50 reads `dataUrl = \`/expenses/\${record.id}\``
- When migration is applied: settlement form note is persisted to the DB and rendered in settlement history
- When Edge Function is redeployed: expense push notification taps navigate to the correct expense detail screen
- Settlement push notification deep-link is unchanged and continues to work
- SETL-01, SETL-03, NOTF-01 status changes from PARTIAL to SATISFIED
</success_criteria>

<output>
After completion, create `.planning/phases/05-schema-notification-fixes/05-01-SUMMARY.md` following the summary template at `@./.claude/get-shit-done/templates/summary.md`.
</output>
