---
phase: 01-foundation
plan: "04"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/supabase.ts
autonomous: false
gap_closure: true
requirements:
  - AUTH-01
  - AUTH-02
  - AUTH-03
  - AUTH-04
  - AUTH-05
  - GRUP-01
  - GRUP-02
  - GRUP-03
  - GRUP-04
  - GRUP-05
  - OFFL-01
  - UIUX-01

must_haves:
  truths:
    - "CI security-scan job passes on every push — no false-positive match on comments in supabase.ts"
    - "EAS dev client build exists for at least one platform — build ID or EAS dashboard URL recorded"
  artifacts:
    - path: "src/lib/supabase.ts"
      provides: "Supabase singleton client — comment must not contain SERVICE_ROLE_KEY verbatim"
      contains: "service role key"
    - path: ".github/workflows/ci.yml"
      provides: "CI pipeline with service_role grep scan"
      contains: "SERVICE_ROLE_KEY"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "src/lib/supabase.ts"
      via: "grep scan — must not match comment on line 8"
      pattern: "SERVICE_ROLE_KEY"
---

<objective>
Close the two gaps identified in 01-VERIFICATION.md that block complete Phase 1 goal achievement.

Gap 1 (auto): The CI security-scan grep pattern `SERVICE_ROLE_KEY` false-positives on a developer-safety comment in `src/lib/supabase.ts` line 8, causing the CI pipeline to permanently fail before it can guard anything real. Fix by rewriting the comment to avoid the exact variable-name literal.

Gap 2 (checkpoint): No EAS dev client build has ever been triggered. The phase goal states "a deployed app shell" and plan 01-01 explicitly requires "EAS dev client builds successfully for at least one platform." Without a build, the architectural decision to use EAS dev client (over Expo Go) for MMKV v4 and expo-sqlite is unverified.

Purpose: Complete Phase 1 verification so the phase is fully done and Phase 2 can begin cleanly.
Output: A CI pipeline that passes on push, and a logged EAS build ID/URL proving native modules link correctly.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01-foundation/01-VERIFICATION.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

<interfaces>
<!-- Key patterns the executor needs. Extracted from existing files. -->

From src/lib/supabase.ts (current line 8 — the problem line):
```
// SECURITY: Only the anon key goes here. NEVER import or use SUPABASE_SERVICE_ROLE_KEY
// in any client-side file. Service role key lives in Supabase Vault + CI secrets only.
```
The grep pattern in ci.yml matches: `SERVICE_ROLE_KEY|service_role_key|serviceRoleKey`

From .github/workflows/ci.yml (lines 46-57 — the scan step):
```yaml
if grep -r "SERVICE_ROLE_KEY\|service_role_key\|serviceRoleKey" \
     --include="*.ts" \
     --include="*.tsx" \
     --include="*.js" \
     --include="*.jsx" \
     --include="*.json" \
     --include="app.config.*" \
     --include="eas.json" \
     --exclude-dir=".git" \
     --exclude-dir="node_modules" \
     --exclude-dir="supabase" \
     . ; then
```
This matches the comment in supabase.ts and exits 1, failing CI on every push.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix CI false-positive by rewriting safety comment in supabase.ts</name>
  <files>src/lib/supabase.ts</files>
  <action>
Edit `src/lib/supabase.ts` line 8. Change the security comment so it no longer contains the literal string `SERVICE_ROLE_KEY` (which is the grep pattern used by the CI security-scan job).

Current line 8 (causes false-positive):
```typescript
// SECURITY: Only the anon key goes here. NEVER import or use SUPABASE_SERVICE_ROLE_KEY
// in any client-side file. Service role key lives in Supabase Vault + CI secrets only.
```

Replace with (uses natural language instead of the variable name literal):
```typescript
// SECURITY: Only the anon key goes here. NEVER import or use the Supabase service role key
// in any client-side file. It belongs only in Supabase Vault and CI secrets.
```

This preserves the security intent of the comment while removing the exact token that the CI grep pattern matches. Do NOT modify any other line in supabase.ts — the rest of the file is correct.

After editing, verify the fix by running the same grep the CI uses locally to confirm zero matches.
  </action>
  <verify>
    <automated>grep -r "SERVICE_ROLE_KEY\|service_role_key\|serviceRoleKey" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --include="*.json" --exclude-dir=".git" --exclude-dir="node_modules" --exclude-dir="supabase" . ; echo "grep-exit:$?"</automated>
  </verify>
  <done>
    grep returns no output and exits non-zero (no matches = CI scan would pass). supabase.ts still exports the same `supabase` client with identical auth config — only the comment text changed.
  </done>
</task>

<task type="checkpoint:human-action">
  <name>Task 2: Trigger EAS dev client build to verify MMKV and expo-sqlite link in custom native build</name>
  <action>
Human-only action: Requires EAS account credentials. Claude cannot authenticate to Expo's EAS service.
See what-to-do block below for exact steps.
  </action>
  <verify>
    <automated>MISSING — EAS build verification requires Expo account authentication; human must trigger and confirm</automated>
  </verify>
  <done>
    EAS dev client build completed for at least one platform (Android or iOS simulator). Build URL or "local build succeeded" recorded in SUMMARY.
  </done>
  <what-to-do>
Run the following commands from the project root directory. You need an Expo account (free — create at expo.dev if you don't have one). The iOS simulator build runs locally and does not upload to EAS servers.

**Step 1 — Install EAS CLI globally (if not already installed):**
```bash
pnpm add -g eas-cli
```

**Step 2 — Log in to your Expo account:**
```bash
eas login
```
Enter your Expo account email and password when prompted.

**Step 3 — Link the project to EAS (one-time setup):**
```bash
eas project:init
```
This writes an `extra.eas.projectId` into app.json. Commit that change after.

**Step 4 — Trigger the build. Pick ONE:**

Option A — Android cloud build (no signing credentials needed — eas.json already has `withoutCredentials: true`):
```bash
eas build --platform android --profile development
```

Option B — iOS simulator local build (no Apple account needed):
```bash
eas build --platform ios --profile development --local
```

**What to watch for:**
- Build completes without errors mentioning MMKV, expo-sqlite, or react-native-nitro-modules
- For cloud builds: a URL is printed (https://expo.dev/accounts/.../builds/...)
- For local builds: a .tar.gz or .app file is created in the project directory
  </what-to-do>
  <resume-signal>
Paste the EAS build URL (e.g. https://expo.dev/accounts/username/projects/owe/builds/some-uuid) OR type "local build succeeded" if you ran --local. If the build failed, paste the error output so it can be diagnosed and a fix plan created.
  </resume-signal>
</task>

</tasks>

<verification>
After both tasks complete:

1. Run the CI grep scan locally and confirm zero matches:
   `grep -r "SERVICE_ROLE_KEY\|service_role_key\|serviceRoleKey" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --include="*.json" --exclude-dir=.git --exclude-dir=node_modules --exclude-dir=supabase .`
   Expected: no output (grep exits non-zero = no matches = CI scan passes on push)

2. Confirm EAS build URL or local build success was recorded in SUMMARY.

3. Update 01-VERIFICATION.md: both gap statuses change from `failed` to `verified`, score updates to 16/16, overall status to `verified`.
</verification>

<success_criteria>
- CI security-scan job would pass on any push — no file in the tracked JS/TS/JSON set contains `SERVICE_ROLE_KEY`, `service_role_key`, or `serviceRoleKey`
- At least one EAS dev client build exists (cloud build URL on expo.dev OR local build artifact confirmed)
- 01-VERIFICATION.md score is 16/16, status is `verified`
- Phase 1 is fully complete and Phase 2 can begin
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md` with:
- Gap 1: Confirm comment fix and grep result (zero matches)
- Gap 2: EAS build URL or local build result (verbatim from user's resume signal)
- Confirmation that Phase 1 verification gaps are now closed

Then update `.planning/phases/01-foundation/01-VERIFICATION.md`:
- Change both gap statuses from `failed` to `verified`
- Update the frontmatter `score` from `14/16` to `16/16`
- Update the frontmatter `status` from `gaps_found` to `verified`
- Update the score line in the document body: "14/16 must-haves verified" -> "16/16 must-haves verified"
</output>
