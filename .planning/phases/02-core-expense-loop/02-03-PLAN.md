---
phase: 02-core-expense-loop
plan: 03
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - src/features/settlements/types.ts
  - src/features/settlements/hooks.ts
  - src/features/activity/types.ts
  - src/features/activity/hooks.ts
  - src/components/settlement/ConfettiScreen.tsx
  - app/(app)/settlement/new.tsx
  - app/(app)/settlement/success.tsx
  - app/(app)/groups/[id]/activity.tsx
  - app/(app)/groups/[id]/settlements.tsx
  - app/(app)/expenses/[id]/index.tsx
  - app/_layout.tsx
autonomous: true
requirements:
  - SETL-01
  - SETL-02
  - SETL-03
  - ACTY-01
  - ACTY-02
  - ACTY-03
  - ACTY-04
  - OFFL-02
  - UIUX-02

user_setup: []

must_haves:
  truths:
    - "User can record a settlement payment between two members and see a confetti + haptic success screen"
    - "User can view a list of past settlements for a group"
    - "User can view a chronological activity feed of all expense and settlement actions in a group"
    - "User can filter the activity feed to a specific group"
    - "User can add a text comment on an expense detail screen"
    - "User can add or remove an emoji reaction on an expense in the activity feed"
    - "User can add an expense while offline; it queues in React Query and syncs automatically when connectivity returns"
    - "Expense cards in group screens support left-swipe (Remind) and right-swipe (Settle) gestures"
  artifacts:
    - path: "src/features/settlements/types.ts"
      provides: "Settlement, CreateSettlementInput types"
      exports: ["Settlement", "CreateSettlementInput"]
    - path: "src/features/settlements/hooks.ts"
      provides: "useCreateSettlement, useSettlementHistory hooks"
    - path: "src/features/activity/types.ts"
      provides: "ActivityItem, Comment, Reaction types"
      exports: ["ActivityItem", "Comment", "Reaction"]
    - path: "src/features/activity/hooks.ts"
      provides: "useActivityFeed, useAddComment, useAddReaction, useRemoveReaction hooks"
    - path: "app/(app)/settlement/success.tsx"
      provides: "Confetti + haptic feedback success screen"
    - path: "app/(app)/groups/[id]/activity.tsx"
      provides: "Activity feed screen filterable by group"
    - path: "app/(app)/groups/[id]/settlements.tsx"
      provides: "Settlement history screen listing past settlements for a group"
    - path: "app/_layout.tsx"
      provides: "NetInfo onlineManager + setMutationDefaults + resumePausedMutations wired for OFFL-02"
  key_links:
    - from: "app/(app)/settlement/new.tsx"
      to: "src/features/settlements/hooks.ts useCreateSettlement"
      via: "useMutation call on form submit"
      pattern: "useCreateSettlement"
    - from: "app/(app)/settlement/new.tsx"
      to: "app/(app)/settlement/success.tsx"
      via: "router.replace on settlement success"
      pattern: "router.replace.*settlement/success"
    - from: "app/_layout.tsx"
      to: "src/features/expenses/hooks.ts createExpenseMutationFn"
      via: "queryClient.setMutationDefaults(['expenses','create'], { mutationFn })"
      pattern: "setMutationDefaults"
    - from: "app/_layout.tsx"
      to: "PersistQueryClientProvider onSuccess"
      via: "resumePausedMutations then invalidateQueries"
      pattern: "resumePausedMutations"
    - from: "src/components/expenses/ExpenseCard.tsx"
      to: "app/(app)/settlement/new.tsx"
      via: "right swipe Settle action navigates to settlement form"
      pattern: "router.push.*settlement/new"
    - from: "app/(app)/groups/[id]/settlements.tsx"
      to: "src/features/settlements/hooks.ts useSettlementHistory"
      via: "useSettlementHistory(groupId) called in settlements screen FlatList"
      pattern: "useSettlementHistory"
---

<objective>
Build settlement recording with confetti, the settlement history screen, the activity feed with comments and reactions, and the OFFL-02 offline mutation queue. Also wires the swipe-to-settle gesture on expense cards to navigate to the settlement form.

Purpose: This plan completes Phase 2 by closing the debt loop (settlement + history), providing social proof (activity feed), and making the app resilient offline. Together with 02-01 and 02-02, this delivers the full core product.
Output: Settlement flow, confetti screen, settlement history screen, activity feed, comments, reactions, offline mutation queue via NetInfo + resumePausedMutations.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-expense-loop/02-RESEARCH.md
@.planning/phases/02-core-expense-loop/02-01-SUMMARY.md

<interfaces>
<!-- Types from Plan 02-01; hooks pattern; migration schema from research -->

From src/features/expenses/types.ts (02-01):
```typescript
export interface CreateExpenseInput { ..., idempotency_key: string }
// mutationKey: ['expenses', 'create'] â€” MUST match setMutationDefaults in _layout.tsx
```

From src/features/expenses/hooks.ts (02-01):
```typescript
// The mutationFn from useCreateExpense must be extracted as a standalone function
// so it can be passed to queryClient.setMutationDefaults(['expenses', 'create'], { mutationFn })
export async function createExpenseMutationFn(input: CreateExpenseInput): Promise<Expense>
```

From app/_layout.tsx (existing):
```typescript
// PersistQueryClientProvider wraps entire app:
<PersistQueryClientProvider
  client={queryClient}
  persistOptions={{ persister, maxAge: 1000 * 60 * 60 * 24 }}
  onSuccess={() => {
    // ADD HERE: queryClient.resumePausedMutations().then(() => queryClient.invalidateQueries())
  }}
>
// ADD BEFORE PersistQueryClientProvider: onlineManager.setEventListener(NetInfo setup)
// ADD BEFORE PersistQueryClientProvider: queryClient.setMutationDefaults(['expenses', 'create'], { mutationFn: createExpenseMutationFn })
```

Activities table schema (from migration 20260228000003 created in Plan 02-01):
```sql
-- activities: id, group_id, actor_id, action_type, expense_id, metadata JSONB, created_at
-- expense_comments: id, expense_id, author_id, body, created_at
-- expense_reactions: id, expense_id, user_id, emoji, created_at; UNIQUE(expense_id, user_id)
-- settlements: id, group_id, payer_id, payee_id, amount_cents, currency, note, idempotency_key, settled_at, created_at
```

Offline pattern (OFFL-02) â€” critical implementation notes:
```typescript
// 1. Extract mutationFn from useCreateExpense as a named export
// 2. At app startup (before PersistQueryClientProvider renders):
queryClient.setMutationDefaults(['expenses', 'create'], { mutationFn: createExpenseMutationFn })
// 3. In PersistQueryClientProvider onSuccess:
queryClient.resumePausedMutations().then(() => queryClient.invalidateQueries())
// 4. NetInfo onlineManager (call once at module scope, outside any component):
import NetInfo from '@react-native-community/netinfo'
import { onlineManager } from '@tanstack/react-query'
onlineManager.setEventListener((setOnline) => {
  return NetInfo.addEventListener((state) => {
    setOnline(state.isConnected != null && state.isConnected && Boolean(state.isInternetReachable))
  })
})
// 5. useMutation in useCreateExpense already has networkMode: 'online' as TanStack default
//    â€” mutations created while offline are automatically paused and serialized to persister
```

Confetti + haptic pattern:
```typescript
import ConfettiCannon from 'react-native-confetti-cannon'
import * as Haptics from 'expo-haptics'
// On mount: Haptics.notificationAsync(Haptics.NotificationFeedbackType.Success) then confettiRef.current?.start()
// Colors: ['#6C63FF', '#00F5D4', '#06D6A0', '#FF4D6D'] (brand colors from tailwind config)
```

New packages to install:
```bash
pnpm add react-native-confetti-cannon
npx expo install @react-native-community/netinfo expo-haptics
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install packages + wire OFFL-02 offline queue + settlement types and hooks + activity types and hooks</name>
  <files>
    src/features/settlements/types.ts,
    src/features/settlements/hooks.ts,
    src/features/activity/types.ts,
    src/features/activity/hooks.ts,
    src/features/expenses/hooks.ts,
    app/_layout.tsx
  </files>
  <action>
1. Install new packages:
```bash
cd "/c/Aman/Coding-Bamzii/Web Development/Owe"
pnpm add react-native-confetti-cannon
npx expo install @react-native-community/netinfo expo-haptics
```

2. Update `src/features/expenses/hooks.ts`. Extract the mutationFn from `useCreateExpense` as a named export:
```typescript
// Extract as standalone function (required for setMutationDefaults â€” function ref must survive serialization)
export async function createExpenseMutationFn(input: CreateExpenseInput): Promise<Expense> {
  // ... same implementation that was inside useMutation mutationFn
}

export function useCreateExpense() {
  const qc = useQueryClient()
  return useMutation({
    mutationKey: ['expenses', 'create'],
    mutationFn: createExpenseMutationFn,  // reference, not inline function
    onSuccess: (_data, input) => {
      qc.invalidateQueries({ queryKey: ['expenses', input.group_id] })
      qc.invalidateQueries({ queryKey: ['balances'] })
    },
  })
}
```
This extraction is required for OFFL-02: `setMutationDefaults` needs the same function reference at startup.

3. Update `app/_layout.tsx`. Add NetInfo onlineManager setup and mutation defaults at the top of the file (module scope, outside any component):
```typescript
import NetInfo from '@react-native-community/netinfo'
import { onlineManager } from '@tanstack/react-query'
import { queryClient } from '@/lib/queryClient'
import { createExpenseMutationFn } from '@/features/expenses/hooks'

// Module-level setup â€” runs once when the module loads (before any component mounts)
onlineManager.setEventListener((setOnline) => {
  return NetInfo.addEventListener((state) => {
    setOnline(
      state.isConnected != null &&
      state.isConnected &&
      Boolean(state.isInternetReachable)
    )
  })
})

// Register mutationFn so paused mutations can resume after app restart (OFFL-02)
// mutationKey MUST exactly match ['expenses', 'create'] in useCreateExpense
queryClient.setMutationDefaults(['expenses', 'create'], {
  mutationFn: createExpenseMutationFn,
})
```
Then update the `PersistQueryClientProvider` `onSuccess` callback:
```typescript
onSuccess={() => {
  // Replay any mutations that were queued while offline (OFFL-02)
  queryClient.resumePausedMutations().then(() => {
    queryClient.invalidateQueries()
  })
}}
```

4. Create `src/features/settlements/types.ts`:
```typescript
export interface Settlement {
  id: string
  group_id: string
  payer_id: string       // group_members.id of person paying
  payee_id: string       // group_members.id of person receiving
  amount_cents: number
  currency: string
  note: string | null
  idempotency_key: string
  settled_at: string
  created_at: string
}

export interface CreateSettlementInput {
  group_id: string
  payer_member_id: string
  payee_member_id: string
  amount_cents: number
  currency?: string
  note?: string
  idempotency_key: string
}
```

5. Create `src/features/settlements/hooks.ts`:

**useCreateSettlement():** mutationKey `['settlements', 'create']`. INSERT into settlements table with all fields from `CreateSettlementInput`. Also INSERT an activity row (action_type: 'settlement_recorded', group_id, actor_id = current user's member_id). On success: invalidate `['settlements', group_id]`, `['balances']`, `['activity', group_id]`.

**useSettlementHistory(groupId: string):** queryKey `['settlements', groupId]`, staleTime 30_000. Fetch settlements WHERE group_id = groupId ORDER BY settled_at DESC. Join payer and payee group_members for display_names (select with FK expansion or a second members fetch). Return `Settlement[]` enriched with `payer_display_name` and `payee_display_name` string fields (extend or augment the base Settlement type with `& { payer_display_name: string; payee_display_name: string }`).

6. Create `src/features/activity/types.ts`:
```typescript
export interface ActivityItem {
  id: string
  group_id: string
  actor_id: string | null
  actor_display_name: string | null
  action_type: 'expense_added' | 'expense_edited' | 'expense_deleted' | 'settlement_recorded' | 'comment_added' | 'reaction_added'
  expense_id: string | null
  metadata: Record<string, unknown> | null
  created_at: string
}

export interface Comment {
  id: string
  expense_id: string
  author_id: string
  author_display_name?: string
  body: string
  created_at: string
}

export interface Reaction {
  id: string
  expense_id: string
  user_id: string
  emoji: string
  created_at: string
}
```

7. Create `src/features/activity/hooks.ts`:

**useActivityFeed(groupId?: string):** queryKey `['activity', groupId ?? 'all']`, staleTime 30_000. If groupId provided: filter activities WHERE group_id = groupId. If not: fetch activities for all groups the current user belongs to (join through group_members). Join actor profile display_name via select with FK expansion. Order by created_at DESC. Limit 100.

**useAddComment():** mutationKey `['comments', 'create']`. INSERT into expense_comments (expense_id, author_id = current user id, body). Also INSERT activity row (action_type: 'comment_added', group_id fetched from the expense). On success: invalidate `['comments', expense_id]` and `['activity']`.

**useComments(expenseId: string):** queryKey `['comments', expenseId]`. Fetch comments WHERE expense_id = expenseId ORDER BY created_at ASC. Join author profile for display_name.

**useAddReaction():** mutationKey `['reactions', 'create']`. UPSERT into expense_reactions (on conflict (expense_id, user_id) DO UPDATE SET emoji = excluded.emoji). On success: invalidate `['reactions', expense_id]`.

**useRemoveReaction():** mutationKey `['reactions', 'delete']`. DELETE from expense_reactions WHERE expense_id = $1 AND user_id = auth.uid(). On success: invalidate `['reactions', expense_id]`.

**useReactions(expenseId: string):** queryKey `['reactions', expenseId]`. Fetch all reactions for expense.
  </action>
  <verify>
    <automated>cd "/c/Aman/Coding-Bamzii/Web Development/Owe" && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>
    - @react-native-community/netinfo and expo-haptics and react-native-confetti-cannon in package.json
    - createExpenseMutationFn exported from expenses/hooks.ts (not inline in useMutation)
    - app/_layout.tsx has onlineManager.setEventListener with NetInfo at module scope
    - app/_layout.tsx has queryClient.setMutationDefaults(['expenses','create'], { mutationFn: createExpenseMutationFn })
    - PersistQueryClientProvider onSuccess calls resumePausedMutations().then(invalidateQueries)
    - settlements/types.ts and hooks.ts exist with Settlement, CreateSettlementInput, useCreateSettlement, useSettlementHistory
    - useSettlementHistory fetches payer and payee display_names (not just raw IDs)
    - activity/types.ts and hooks.ts exist with all hooks
    - TypeScript compiles clean
  </done>
</task>

<task type="auto">
  <name>Task 2: Settlement screens + confetti + settlement history screen + activity feed + comments + reactions + swipe wire-up</name>
  <files>
    src/components/settlement/ConfettiScreen.tsx,
    app/(app)/settlement/new.tsx,
    app/(app)/settlement/success.tsx,
    app/(app)/groups/[id]/activity.tsx,
    app/(app)/groups/[id]/settlements.tsx,
    app/(app)/expenses/[id]/index.tsx
  </files>
  <action>
1. Create `src/components/settlement/ConfettiScreen.tsx`. Standalone component that fires confetti and haptics on mount:
```typescript
import ConfettiCannon from 'react-native-confetti-cannon'
import * as Haptics from 'expo-haptics'
import { useEffect, useRef } from 'react'

export function ConfettiScreen({ onDismiss }: { onDismiss: () => void }) {
  const confettiRef = useRef<ConfettiCannon>(null)
  useEffect(() => {
    Haptics.notificationAsync(Haptics.NotificationFeedbackType.Success)
    confettiRef.current?.start()
  }, [])
  return (
    <View className="flex-1 bg-dark-bg items-center justify-center">
      <ConfettiCannon
        ref={confettiRef}
        count={200}
        origin={{ x: -10, y: 0 }}
        autoStart={false}
        colors={['#6C63FF', '#00F5D4', '#06D6A0', '#FF4D6D']}
        fallSpeed={3000}
        fadeOut
      />
      <Text className="text-white text-3xl font-bold mb-2">All settled!</Text>
      <Text className="text-white/50 text-base mb-8">Debt cleared</Text>
      <TouchableOpacity onPress={onDismiss} className="bg-brand-primary px-8 py-3 rounded-full">
        <Text className="text-white font-semibold">Done</Text>
      </TouchableOpacity>
    </View>
  )
}
```

2. Create `app/(app)/settlement/new.tsx`. Route params: `group_id`, `payer_member_id` (optional pre-fill from swipe-to-settle), `payee_member_id` (optional), `amount_cents` (optional pre-fill from simplified debts screen).
   - Stack.Screen title: "Record Settlement"
   - Form fields:
     - Amount: TextInput controlled with placeholder "$0.00". Convert to cents on submit: `Math.round(parseFloat(value) * 100)`.
     - Payer: picker (member FlatList modal) pre-filled if payer_member_id param present
     - Payee: picker (member FlatList modal) pre-filled if payee_member_id param present
     - Note: optional TextInput max 200 chars
   - Validate: amount > 0, payer !== payee, both payer and payee selected.
   - On submit: `useCreateSettlement().mutate({ ..., idempotency_key: crypto.randomUUID() })`. On success: `router.replace('/(app)/settlement/success')`. Pass settlement details as params to success screen if needed.
   - Member list loaded via `useGroup(groupId)` from groups feature.

3. Create `app/(app)/settlement/success.tsx`. Renders `<ConfettiScreen onDismiss={() => router.replace('/(app)')} />`. Stack.Screen with `headerShown: false` so confetti uses full screen.

4. Create `app/(app)/groups/[id]/activity.tsx`. Activity feed screen for a group:
   - Stack.Screen title: "Activity"
   - `useLocalSearchParams()` for groupId
   - Call `useActivityFeed(groupId)` (filtered to this group)
   - FlatList of activity items. Each item renders:
     - actor_display_name (white, semibold)
     - action_type human-readable label:
       - 'expense_added' â†’ "added an expense"
       - 'expense_edited' â†’ "edited an expense"
       - 'expense_deleted' â†’ "deleted an expense"
       - 'settlement_recorded' â†’ "recorded a settlement"
       - 'comment_added' â†’ "commented"
       - 'reaction_added' â†’ "reacted"
     - expense description from metadata if available (text-white/50)
     - relative time (created_at formatted as "2h ago", "yesterday", etc. â€” use simple logic: if < 60min show "Xm ago", if < 24h show "Xh ago", else show date)
     - If action involves an expense (expense_id not null): tapping the row navigates to `/(app)/expenses/${item.expense_id}`
   - Card style: `bg-dark-surface rounded-xl px-4 py-3 mb-2`
   - If no activities: "No activity yet" placeholder centered.

5. Create `app/(app)/groups/[id]/settlements.tsx`. Settlement history screen for a group (SETL-03):
   - Stack.Screen title: "Settlement History"
   - `useLocalSearchParams()` for groupId
   - Call `useSettlementHistory(groupId)` â€” returns settlements enriched with payer_display_name and payee_display_name
   - FlatList of past settlements. Each row renders:
     - "{payer_display_name} paid {payee_display_name}" (white, semibold)
     - Amount formatted as dollars: `$${(settlement.amount_cents / 100).toFixed(2)}` (text-green-400, font-bold)
     - settled_at formatted as a readable date (e.g., "Feb 28, 2026")
     - note if present (text-white/50, text-sm, below the name line)
   - Card style: `bg-dark-surface border border-dark-border rounded-xl px-4 py-3 mb-2`
   - If isLoading: ActivityIndicator centered.
   - If no settlements: "No settlements yet" placeholder centered (text-white/50).

6. Update `app/(app)/expenses/[id]/index.tsx` (extended from Plan 02-01 base). Add below the expense details:
   - **Reactions section:** Call `useReactions(expenseId)`. Show emoji reaction chips horizontally. If current user has a reaction, highlight their chip (bg-brand-primary/20 border border-brand-primary). Tapping own reaction calls `useRemoveReaction`. Tapping "+" opens an emoji picker (simple TouchableOpacity grid of 8 common emojis: ðŸ‘ â¤ï¸ ðŸ˜‚ ðŸ˜® ðŸ˜¢ ðŸŽ‰ ðŸ™ ðŸ’¯) that calls `useAddReaction`. Place emojis inline below expense details.
   - **Comments section:** Call `useComments(expenseId)`. FlatList of comments: author_display_name (brand-primary, xs), comment body (white), time (white/30, xs). Below the list: a TextInput row with "Add a comment..." placeholder and a "Send" button (brand-primary). On send: `useAddComment().mutate({ expense_id: expenseId, body: trimmedText })`, clear input on success.

7. Update `src/components/expenses/ExpenseCard.tsx` swipe actions (from Plan 02-01). Wire right swipe Settle action to navigate to the settlement form:
```typescript
// Right swipe â†’ Settle
onPress={() => {
  swipeRef.current?.close()
  router.push({
    pathname: '/(app)/settlement/new',
    params: { group_id: expense.group_id, payer_member_id: '', payee_member_id: '' }
    // payer/payee pre-fill requires knowing current user's member_id â€” leave blank for manual pick on settlement form
  })
}}

// Left swipe â†’ Remind (Phase 3 push notifications)
onPress={() => {
  swipeRef.current?.close()
  Alert.alert('Remind', 'Push reminders will be available in the next update.')
}}
```
  </action>
  <verify>
    <automated>cd "/c/Aman/Coding-Bamzii/Web Development/Owe" && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>
    - Settlement form screen renders with payer/payee member pickers and amount field
    - On settlement success: navigates to success screen with confetti animation firing on mount
    - Haptics fire on settlement success screen mount
    - Settlement history screen (app/(app)/groups/[id]/settlements.tsx) exists, calls useSettlementHistory(groupId), and renders past settlements in a FlatList
    - Activity feed screen shows chronological list filterable by group_id
    - Expense detail screen shows emoji reactions (add/remove) and comment thread
    - ExpenseCard right swipe navigates to settlement/new with group_id param
    - ExpenseCard left swipe shows alert (placeholder for Phase 3 push remind)
    - TypeScript compiles clean across all new files
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with 0 errors
2. `pnpm list react-native-confetti-cannon @react-native-community/netinfo expo-haptics` shows all three installed
3. app/_layout.tsx contains `onlineManager.setEventListener` and `setMutationDefaults(['expenses', 'create']` and `resumePausedMutations()` in onSuccess
4. Settlement flow: open settlement/new â†’ fill form â†’ submit â†’ success screen fires confetti + haptic
5. Settlement history: after recording a settlement, navigate to groups/[id]/settlements â€” past settlement row appears with payer name, payee name, amount, date
6. Activity feed: after adding expense, activity screen for that group shows "added an expense" row
7. Comments: add comment on expense detail â†’ appears in list below
8. Reactions: tap emoji on expense detail â†’ reaction chip appears; tap again â†’ removes
9. Offline test: enable airplane mode â†’ add expense via form â†’ enable network â†’ expense syncs to Supabase
</verification>

<success_criteria>
- Settlement can be recorded from the settlement form; success shows full-screen confetti with haptic feedback
- Settlement history is viewable per group via the settlements screen (SETL-03 satisfied)
- Activity feed shows chronological actions across all groups; filterable by group
- Users can add comments and emoji reactions on expense detail screens
- Expense cards support right swipe to settle (navigates to settlement form) and left swipe with reminder placeholder
- Offline expense creation queues via React Query (mutationKey + setMutationDefaults + resumePausedMutations) and syncs on reconnect
- NetInfo onlineManager correctly pauses/resumes React Query network mode based on real connectivity
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-expense-loop/02-03-SUMMARY.md` following the template at `.claude/get-shit-done/templates/summary.md`.
</output>
