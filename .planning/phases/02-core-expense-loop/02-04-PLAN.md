---
phase: 02-core-expense-loop
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260228000004_fix_activities_actor_fk.sql
autonomous: false
gap_closure: true
requirements:
  - ACTY-01
  - ACTY-02
  - ACTY-03

must_haves:
  truths:
    - "Activity rows can be inserted without a foreign key violation"
    - "useAddComment succeeds end-to-end (comment row + activity row both commit)"
    - "useCreateSettlement inserts its activity row without throwing"
    - "useActivityFeed returns populated rows for a group after an expense or settlement is recorded"
    - "useActivityFeed all-groups view returns populated rows across multiple groups"
  artifacts:
    - path: "supabase/migrations/20260228000004_fix_activities_actor_fk.sql"
      provides: "Corrected FK: activities.actor_id references group_members(id)"
      contains: "DROP CONSTRAINT activities_actor_id_fkey"
    - path: "src/features/activity/hooks.ts"
      provides: "useActivityFeed, useAddComment with correct actor resolution"
      exports: ["useActivityFeed", "useAddComment", "useComments", "useAddReaction", "useRemoveReaction", "useReactions"]
    - path: "src/features/settlements/hooks.ts"
      provides: "useCreateSettlement with activity insert aligned to group_members FK"
      exports: ["useCreateSettlement", "useSettlementHistory"]
  key_links:
    - from: "supabase/migrations/20260228000004_fix_activities_actor_fk.sql"
      to: "public.activities.actor_id"
      via: "ALTER TABLE DROP CONSTRAINT / ADD CONSTRAINT"
      pattern: "DROP CONSTRAINT activities_actor_id_fkey"
    - from: "src/features/activity/hooks.ts"
      to: "activities table"
      via: "INSERT actor_id = actorMember.id (group_members.id) — now valid after migration"
      pattern: "actor_id: actorMember\\.id"
    - from: "src/features/activity/hooks.ts"
      to: "group_members table"
      via: "PostgREST join actor:group_members!actor_id(display_name) — aligned with FK"
      pattern: "actor:group_members!actor_id"
---

<objective>
Fix the single root-cause schema-code mismatch that blocks ACTY-01, ACTY-02, and ACTY-03.

The `activities.actor_id` column carries a FK to `public.profiles(id)`, but all code paths
(useAddComment, useCreateSettlement) insert `group_members.id` values as `actor_id`. This causes
a FK violation on every INSERT into `activities`, leaving the feed permanently empty and the comment
mutation permanently broken.

The fix is a targeted new migration that drops the wrong FK constraint and adds the correct one
pointing to `public.group_members(id)`. The hooks are already written correctly for the
group_members pattern — no hook changes are needed. Verification requires a live Supabase instance
to confirm runtime behavior.

Purpose: Unblock ACTY-01 (activity feed), ACTY-02 (filter by group), ACTY-03 (add comment) — the
only three requirements blocked by this gap.

Output: New migration file. Human verification confirms feed populates at runtime.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-expense-loop/02-VERIFICATION.md
</context>

<interfaces>
<!-- Key types and contracts needed by the executor. Extracted from codebase. -->

From supabase/migrations/20260228000003_expense_loop.sql (the broken definition):
```sql
-- BROKEN — FK points to profiles; code inserts group_members.id
actor_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL
-- PostgreSQL auto-names this constraint: activities_actor_id_fkey
```

From src/features/activity/hooks.ts (already correct for group_members pattern):
```typescript
// INSERT: inserts group_members.id as actor_id — correct intent
actor_id: actorMember.id  // actorMember fetched from group_members table

// SELECT join: aligned with group_members pattern — correct
.select('*, actor:group_members!actor_id(display_name)')
```

From src/features/settlements/hooks.ts (already correct for group_members pattern):
```typescript
// INSERT: inserts group_members.id as actor_id — correct intent
actor_id: actorMember.id  // actorMember fetched from group_members
```

The target state after fix:
```sql
-- CORRECT — FK points to group_members; matches what code inserts
actor_id UUID REFERENCES public.group_members(id) ON DELETE SET NULL
```
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Add corrective migration to fix activities.actor_id FK</name>
  <files>supabase/migrations/20260228000004_fix_activities_actor_fk.sql</files>
  <action>
    Create a new Supabase migration file at `supabase/migrations/20260228000004_fix_activities_actor_fk.sql`.

    The migration must:
    1. Drop the incorrect FK constraint `activities_actor_id_fkey` (auto-named by PostgreSQL from the
       inline `REFERENCES public.profiles(id)` definition in the CREATE TABLE statement).
    2. Add a new FK constraint on `actor_id` pointing to `public.group_members(id) ON DELETE SET NULL`.

    Exact SQL to write (no other changes — do not touch RLS policies, indexes, or other columns):

    ```sql
    -- Gap closure: fix activities.actor_id FK from profiles to group_members
    -- Root cause: migration 20260228000003 set actor_id FK to profiles(id), but all code paths
    -- insert group_members.id values. This caused FK violations on every INSERT into activities.
    -- Fix: drop the incorrect constraint and add the correct one pointing to group_members(id).

    ALTER TABLE public.activities
      DROP CONSTRAINT activities_actor_id_fkey;

    ALTER TABLE public.activities
      ADD CONSTRAINT activities_actor_id_fkey
        FOREIGN KEY (actor_id)
        REFERENCES public.group_members(id)
        ON DELETE SET NULL;
    ```

    After writing the file, run `npx supabase db diff` or inspect the file to confirm syntax is valid SQL.
    The hooks do NOT need to be modified — they already insert `group_members.id` and join via
    `actor:group_members!actor_id(display_name)`, which is exactly correct for the new FK.

    Decision: Using `group_members(id)` approach (not `profiles.id` approach) per VERIFICATION.md
    recommendation — it preserves the existing actor resolution pattern in useAddComment and
    useCreateSettlement without requiring hook rewrites.
  </action>
  <verify>
    <automated>cat "supabase/migrations/20260228000004_fix_activities_actor_fk.sql" | grep -c "DROP CONSTRAINT activities_actor_id_fkey" && cat "supabase/migrations/20260228000004_fix_activities_actor_fk.sql" | grep -c "REFERENCES public.group_members(id)"</automated>
  </verify>
  <done>
    Migration file exists at `supabase/migrations/20260228000004_fix_activities_actor_fk.sql`.
    File contains both `DROP CONSTRAINT activities_actor_id_fkey` and `REFERENCES public.group_members(id)`.
    No changes to hooks.ts files (they are already correct).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Migration `20260228000004_fix_activities_actor_fk.sql` that corrects `activities.actor_id` FK
    from `profiles(id)` to `group_members(id)`. When applied, all activity INSERT operations
    (useAddComment, useCreateSettlement) will succeed without FK violations. The activity feed
    (useActivityFeed) will then return real data for the first time.
  </what-built>
  <how-to-verify>
    Apply the migration to your hosted Supabase project first:
    ```
    supabase db push
    ```
    Or apply via the Supabase Dashboard SQL editor if you prefer manual apply.

    Then test the following flows in the app (simulator or device):

    1. **Activity feed populates after expense creation:**
       - Open a group that has at least one member
       - Add a new expense via the FAB -> Manual Entry
       - Navigate to the group's Activity tab (Groups -> [Group] -> Activity)
       - Expected: At least one row appears showing "[your display name] added an expense" with a
         relative timestamp (e.g., "just now")

    2. **Comment flow succeeds end-to-end:**
       - Open any expense detail screen (tap an expense card)
       - Type a comment in the comment field and submit
       - Expected: Comment appears in the thread below; no error toast is shown

    3. **Settlement activity row recorded:**
       - Navigate to a group's Simplified Debts or Balances screen
       - Record a settlement payment
       - Navigate to the group's Activity tab
       - Expected: A "settlement recorded" activity row appears in the feed

    Confirm all three pass before typing "approved".
  </how-to-verify>
  <resume-signal>Type "approved" if all three flows work, or describe which step failed and what error appeared</resume-signal>
</task>

</tasks>

<verification>
Static verification (automated):
- Migration file exists: `supabase/migrations/20260228000004_fix_activities_actor_fk.sql`
- File contains DROP CONSTRAINT on `activities_actor_id_fkey`
- File contains ADD CONSTRAINT pointing to `public.group_members(id)`
- No hooks.ts files were modified (they were already correct)
- TypeScript still compiles: `npx tsc --noEmit` exits 0

Runtime verification (human required — see checkpoint above):
- Activity feed shows rows after expense creation (ACTY-01)
- Activity feed filtered by group works (ACTY-02)
- Comment addition succeeds without throwing (ACTY-03)
</verification>

<success_criteria>
- `supabase/migrations/20260228000004_fix_activities_actor_fk.sql` exists and contains the correct ALTER TABLE statements
- When migration is applied to hosted Supabase, activity rows can be inserted without FK violation
- After adding an expense, the group's Activity screen shows a populated feed row
- After adding a comment, the comment appears and no error is thrown
- ACTY-01, ACTY-02, ACTY-03 status changes from BLOCKED to SATISFIED
- 19/19 Phase 2 observable truths verified (up from 17/19)
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-expense-loop/02-04-SUMMARY.md` following the summary template at `@./.claude/get-shit-done/templates/summary.md`.
</output>
