---
phase: 1.5-google-oauth-inserted
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/features/auth/hooks.ts
  - app/(auth)/sign-in.tsx
  - app/(auth)/sign-up.tsx
  - supabase/migrations/20260228000002_google_oauth.sql
  - package.json
autonomous: true
requirements:
  - AUTH-06
  - AUTH-07

must_haves:
  truths:
    - "User can tap 'Continue with Google' on the sign-in screen, complete the OAuth flow in the system browser, and land on the dashboard fully authenticated"
    - "User can tap 'Continue with Google' on the sign-up screen and create a new account via Google — no password required"
    - "A Google sign-in using an email already registered via email/password is automatically linked to that existing account — no duplicate user created"
    - "A brand-new Google OAuth user has display_name and avatar_url correctly populated in their profiles row from Google metadata"
    - "All existing email/password flows (sign up, sign in, sign out, session persistence) continue to work exactly as before — zero regressions"
    - "If the Android system closes and cold-starts the app via the OAuth redirect deep link, the session is still established"

  artifacts:
    - path: "src/features/auth/hooks.ts"
      provides: "useSignInWithGoogle hook and createSessionFromUrl helper — additive exports alongside existing auth hooks"
      exports: ["useSignInWithGoogle", "createSessionFromUrl"]

    - path: "supabase/migrations/20260228000002_google_oauth.sql"
      provides: "Patched handle_new_user trigger — COALESCE across display_name and full_name keys, plus avatar_url from Google metadata"
      contains: "CREATE OR REPLACE FUNCTION public.handle_new_user"

    - path: "app/(auth)/sign-in.tsx"
      provides: "sign-in screen with 'Continue with Google' button, divider, cold-start Linking handler, WebBrowser warmup"

    - path: "app/(auth)/sign-up.tsx"
      provides: "sign-up screen with 'Continue with Google' button, divider, cold-start Linking handler, WebBrowser warmup"

  key_links:
    - from: "app/(auth)/sign-in.tsx + app/(auth)/sign-up.tsx"
      to: "useSignInWithGoogle in src/features/auth/hooks.ts"
      via: "import { useSignInWithGoogle } from '@/features/auth/hooks'"
      pattern: "useSignInWithGoogle"

    - from: "useSignInWithGoogle"
      to: "supabase.auth.signInWithOAuth + WebBrowser.openAuthSessionAsync"
      via: "mutationFn in useMutation"
      pattern: "signInWithOAuth.*provider.*google"

    - from: "createSessionFromUrl"
      to: "supabase.auth.setSession"
      via: "QueryParams.getQueryParams(url) extracts access_token"
      pattern: "supabase.auth.setSession"

    - from: "supabase.auth.setSession"
      to: "onAuthStateChange in useSession"
      via: "Supabase SDK fires the subscriber — triggers navigation to (app) stack"
      pattern: "onAuthStateChange"

    - from: "supabase/migrations/20260228000002_google_oauth.sql"
      to: "public.profiles (display_name, avatar_url)"
      via: "COALESCE(raw_user_meta_data->>'display_name', raw_user_meta_data->>'full_name') and raw_user_meta_data->>'avatar_url'"
      pattern: "COALESCE.*display_name.*full_name"

user_setup:
  - service: supabase-redirect-url
    why: "OAuth redirect URL allowlist — Supabase rejects redirects not in the allowlist"
    env_vars: []
    dashboard_config:
      - task: "Add nexus://** to Redirect URLs allowlist"
        location: "Supabase Dashboard → Auth → URL Configuration → Redirect URLs"
        detail: "Add the wildcard entry 'nexus://**' — this covers any path makeRedirectUri() appends to the nexus:// scheme"
---

<objective>
Add Google OAuth as a second sign-in path alongside the existing email/password flow.

Purpose: Users can authenticate with one tap via Google without a password. New Google users get their profile pre-populated from Google metadata. Existing email/password users who sign in with Google are automatically linked — no duplicate account. Zero changes to existing auth behavior.

Output:
- `useSignInWithGoogle` hook + `createSessionFromUrl` helper added to existing `src/features/auth/hooks.ts`
- "Continue with Google" button + divider + cold-start handler wired into both `app/(auth)/sign-in.tsx` and `app/(auth)/sign-up.tsx`
- New migration `supabase/migrations/20260228000002_google_oauth.sql` patching `handle_new_user` trigger to populate `avatar_url` and handle Google's `full_name` key
- `expo-auth-session`, `expo-web-browser`, and `expo-crypto` installed
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/1.5-google-oauth-inserted/1.5-RESEARCH.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
</context>

<interfaces>
<!-- Key interfaces the executor needs. Extracted from codebase. No exploration required. -->

From src/features/auth/hooks.ts (CURRENT — do NOT replace, only ADD exports):
```typescript
// Existing exports — all must remain untouched:
export function useSession(): { session: Session | null; isLoading: boolean }
export function useSignUp(): UseMutationResult<...>  // uses supabase.auth.signUp
export function useSignIn(): UseMutationResult<...>  // uses supabase.auth.signInWithPassword
export function useSignOut(): UseMutationResult<...> // calls globalQueryClient.clear() on success
export function useProfile(): UseQueryResult<Profile>
export function useUpdateProfile(): UseMutationResult<...>

// ADD these two new exports (do not touch any existing function):
export function useSignInWithGoogle(): UseMutationResult<void, Error, void>
export { createSessionFromUrl }  // or export async function createSessionFromUrl(url: string)
```

From src/components/ui/Button.tsx:
```typescript
interface ButtonProps extends TouchableOpacityProps {
  title: string
  variant?: 'primary' | 'secondary' | 'danger'  // NO 'outline' variant — use 'secondary'
}
// 'secondary' renders: bg-dark-surface border border-dark-border
```

From app/(auth)/sign-in.tsx (current imports to preserve):
```typescript
import { View, Text, ScrollView, Alert } from 'react-native'
import { useForm, Controller } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { z } from 'zod'
import { Link } from 'expo-router'
import { Button } from '@/components/ui/Button'
import { Input } from '@/components/ui/Input'
import { useSignIn } from '@/features/auth/hooks'
// ADD: import { useEffect } from 'react'  (or merge into existing React import)
// ADD: import * as Linking from 'expo-linking'
// ADD: import * as WebBrowser from 'expo-web-browser'
// ADD: import { useSignInWithGoogle, createSessionFromUrl } from '@/features/auth/hooks'
```

From app.json:
```json
{ "expo": { "scheme": "nexus" } }
// makeRedirectUri() will produce "nexus://..." — register "nexus://**" in Supabase dashboard
```

From supabase/migrations/20260227000001_foundation.sql — CURRENT trigger (to be replaced by new migration):
```sql
CREATE FUNCTION public.handle_new_user()
RETURNS trigger LANGUAGE plpgsql SECURITY DEFINER SET search_path = ''
AS $$
BEGIN
  INSERT INTO public.profiles (id, display_name)         -- no avatar_url, no full_name fallback
  VALUES (new.id, new.raw_user_meta_data ->> 'display_name');
  RETURN new;
END;
$$;
```
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Install packages, add useSignInWithGoogle hook, and write DB migration</name>
  <files>
    src/features/auth/hooks.ts
    supabase/migrations/20260228000002_google_oauth.sql
    package.json
  </files>
  <action>
**Step 1 — Install packages:**
```bash
npx expo install expo-auth-session expo-web-browser expo-crypto
```
`expo-crypto` is a required peer dependency of `expo-auth-session`. `expo-linking` is already installed (confirmed in RESEARCH.md). Do not install `@react-native-google-signin/google-signin` — the web-browser OAuth approach requires no native SDK changes.

**Step 2 — Add to `src/features/auth/hooks.ts` (additive — append after the last existing export, do NOT touch any existing function):**

Add these imports at the top of the file alongside existing imports:
```typescript
import { makeRedirectUri } from 'expo-auth-session'
import * as QueryParams from 'expo-auth-session/build/QueryParams'
import * as WebBrowser from 'expo-web-browser'
```

Then call at module level (outside any component — this must run once at module initialization):
```typescript
WebBrowser.maybeCompleteAuthSession()
```

Then add the redirect URI constant at module level:
```typescript
const redirectTo = makeRedirectUri()
// Reads "nexus" scheme from app.json automatically.
// Produces "nexus://..." on EAS dev client. Register "nexus://**" in Supabase dashboard.
```

Then add the helper and hook (append after `useUpdateProfile`):
```typescript
// Helper: extract tokens from OAuth redirect URL and call setSession
// Exported so auth screens can use it for cold-start deep link handling
export const createSessionFromUrl = async (url: string) => {
  const { params, errorCode } = QueryParams.getQueryParams(url)
  if (errorCode) throw new Error(errorCode)
  const { access_token, refresh_token } = params
  if (!access_token) return  // User cancelled OAuth — URL has no tokens
  const { data, error } = await supabase.auth.setSession({
    access_token,
    refresh_token: refresh_token ?? '',
  })
  if (error) throw error
  return data.session
  // onAuthStateChange in useSession fires automatically after setSession,
  // routing the user into the (app) stack. No manual navigation needed.
}

// AUTH-06: Google OAuth sign-in (also creates account for new Google users)
// AUTH-07: Account linking is handled server-side by Supabase — no client code needed
export function useSignInWithGoogle() {
  return useMutation({
    mutationFn: async () => {
      // Step 1: Get the Google authorization URL from Supabase
      const { data, error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo,
          skipBrowserRedirect: true,  // Required: we open the browser manually below
        },
      })
      if (error) throw error

      // Step 2: Open Google auth in the system browser and wait for redirect back
      const res = await WebBrowser.openAuthSessionAsync(data?.url ?? '', redirectTo)

      // Step 3: Extract tokens and establish session if browser returned successfully
      if (res.type === 'success') {
        await createSessionFromUrl(res.url)
      }
      // res.type === 'cancel' or 'dismiss': user closed the browser — do nothing
    },
  })
}
```

**Step 3 — Write `supabase/migrations/20260228000002_google_oauth.sql`:**

```sql
-- Migration: 20260228000002_google_oauth.sql
-- Phase 1.5: Patch handle_new_user trigger for Google OAuth users
--
-- Problem: The existing trigger only reads 'display_name' from raw_user_meta_data
-- (the key set during email/password signUp). Google OAuth provides 'full_name'
-- and 'avatar_url' as the keys instead.
--
-- Fix: COALESCE across both key names for display_name; add avatar_url population.
-- CREATE OR REPLACE preserves the existing trigger binding (on_auth_user_created).
-- No DROP/RECREATE of the trigger itself is needed.
--
-- AUTH-07 note: This trigger fires ONLY on INSERT into auth.users (new user creation).
-- For linked accounts (existing email/password user signs in with Google for first time),
-- Supabase adds a row to auth.identities but does NOT INSERT into auth.users.
-- The existing profile.display_name and avatar_url are preserved for linked accounts.
-- This is correct behavior — the success criterion covers "new OAuth users" only.

CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = ''
AS $$
BEGIN
  INSERT INTO public.profiles (id, display_name, avatar_url)
  VALUES (
    new.id,
    COALESCE(
      new.raw_user_meta_data ->> 'display_name',  -- email/password signup path (useSignUp sets this)
      new.raw_user_meta_data ->> 'full_name'       -- Google OAuth path (Google provides this key)
    ),
    new.raw_user_meta_data ->> 'avatar_url'        -- Google OAuth provides this; NULL for email/password (acceptable)
  );
  RETURN new;
END;
$$;
```

After writing the migration file, apply it to the hosted Supabase project:
```bash
supabase db push
```
If `supabase db push` requires authentication, run `supabase login` first and then `supabase link --project-ref <ref>` if not already linked (this is a known manual step from STATE.md).
  </action>
  <verify>
    <automated>
      # 1. Verify packages are installed
      node -e "require('expo-auth-session'); require('expo-web-browser'); require('expo-crypto'); console.log('packages OK')" 2>/dev/null || grep -E '"expo-auth-session"|"expo-web-browser"|"expo-crypto"' "C:/Aman/Coding-Bamzii/Web Development/Owe/package.json"

      # 2. Verify hook exports exist in hooks.ts
      grep -E "useSignInWithGoogle|createSessionFromUrl|WebBrowser\.maybeCompleteAuthSession|signInWithOAuth|openAuthSessionAsync" "C:/Aman/Coding-Bamzii/Web Development/Owe/src/features/auth/hooks.ts"

      # 3. Verify migration file exists with COALESCE and avatar_url
      grep -E "COALESCE|full_name|avatar_url" "C:/Aman/Coding-Bamzii/Web Development/Owe/supabase/migrations/20260228000002_google_oauth.sql"

      # 4. Verify existing hooks are still present (no regressions)
      grep -E "useSession|useSignIn|useSignUp|useSignOut|useProfile|useUpdateProfile" "C:/Aman/Coding-Bamzii/Web Development/Owe/src/features/auth/hooks.ts"

      # 5. TypeScript check on hooks.ts only
      cd "C:/Aman/Coding-Bamzii/Web Development/Owe" && npx tsc --noEmit --skipLibCheck 2>&1 | grep -E "hooks\.ts|error" | head -20
    </automated>
  </verify>
  <done>
    - `expo-auth-session`, `expo-web-browser`, `expo-crypto` present in package.json
    - `src/features/auth/hooks.ts` exports `useSignInWithGoogle` and `createSessionFromUrl` alongside all 6 existing hooks (none removed or modified)
    - `WebBrowser.maybeCompleteAuthSession()` called at module level in hooks.ts
    - `supabase/migrations/20260228000002_google_oauth.sql` exists with `CREATE OR REPLACE FUNCTION public.handle_new_user()` using COALESCE across `display_name`/`full_name` and populating `avatar_url`
    - No TypeScript errors in hooks.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Google button and cold-start handler into sign-in and sign-up screens</name>
  <files>
    app/(auth)/sign-in.tsx
    app/(auth)/sign-up.tsx
  </files>
  <action>
Apply identical additions to both `app/(auth)/sign-in.tsx` and `app/(auth)/sign-up.tsx`. The structure is the same in both files — add to each:

**New imports to add (merge `useEffect` into the existing `react` import if it is not already imported):**
```typescript
import { useEffect } from 'react'
import * as Linking from 'expo-linking'
import * as WebBrowser from 'expo-web-browser'
import { useSignInWithGoogle, createSessionFromUrl } from '@/features/auth/hooks'
```

**Add inside the screen component function, before the `return` statement:**
```typescript
// AUTH-06: WebBrowser warmup — pre-warms Chrome Custom Tabs on Android for faster open
useEffect(() => {
  WebBrowser.warmUpAsync()
  return () => { WebBrowser.coolDownAsync() }
}, [])

// AUTH-06: Cold-start deep link handler — catches OAuth redirect if Android cold-started the app
// WebBrowser.openAuthSessionAsync returns 'cancel' on cold-start; Linking.useURL() catches it
const url = Linking.useURL()
useEffect(() => {
  if (url) createSessionFromUrl(url)
}, [url])

const { mutate: signInWithGoogle, isPending: isPendingGoogle } = useSignInWithGoogle()
```

**Add to the JSX, after the existing primary button and before the sign-up/sign-in link at the bottom:**
```tsx
{/* Divider */}
<View className="my-6 flex-row items-center gap-3">
  <View className="flex-1 h-px bg-white/10" />
  <Text className="text-white/40 text-sm">or</Text>
  <View className="flex-1 h-px bg-white/10" />
</View>

{/* AUTH-06: Google OAuth sign-in button */}
<Button
  title={isPendingGoogle ? 'Opening Google...' : 'Continue with Google'}
  onPress={() => signInWithGoogle(undefined, {
    onError: (error) => Alert.alert('Google Sign-In Failed', error.message),
  })}
  disabled={isPendingGoogle}
  variant="secondary"
/>
```

**Important notes:**
- The Button component does NOT have an `'outline'` variant. Use `variant="secondary"` which renders `bg-dark-surface border border-dark-border` — visually distinct from the primary CTA.
- The divider + Google button goes BETWEEN the primary button and the sign-in/sign-up navigation link — the navigation link stays at the very bottom.
- Do NOT remove or modify any existing JSX, form logic, or imports.
- `Alert` is already imported in both screens — do not duplicate the import.
- In sign-in.tsx, `useEffect` may need to be added to the React import: change `import { ... } from 'react'` to include `useEffect`.
- In sign-up.tsx, same pattern — check if `useEffect` is already imported and add it if not.

**Final structure of each screen's JSX body (sign-in.tsx shown, sign-up.tsx is identical in structure):**
```
[Heading/subtitle text]
[Form fields (email, password for sign-in; displayName, email, password for sign-up)]
[Primary button: "Sign in" / "Create account"]
[Divider with "or" text]          ← NEW
[Google button: "Continue with Google"]  ← NEW
[Navigation link: "New here? Create account" / "Already have an account? Sign in"]
```
  </action>
  <verify>
    <automated>
      # 1. Verify Google hook is imported and used in sign-in.tsx
      grep -E "useSignInWithGoogle|createSessionFromUrl|warmUpAsync|coolDownAsync|isPendingGoogle|Continue with Google|Linking\.useURL" "C:/Aman/Coding-Bamzii/Web Development/Owe/app/(auth)/sign-in.tsx"

      # 2. Verify Google hook is imported and used in sign-up.tsx
      grep -E "useSignInWithGoogle|createSessionFromUrl|warmUpAsync|coolDownAsync|isPendingGoogle|Continue with Google|Linking\.useURL" "C:/Aman/Coding-Bamzii/Web Development/Owe/app/(auth)/sign-up.tsx"

      # 3. Verify existing email/password logic is still intact in both screens
      grep -E "useSignIn|useSignUp|handleSubmit|onSubmit|zodResolver" "C:/Aman/Coding-Bamzii/Web Development/Owe/app/(auth)/sign-in.tsx"
      grep -E "useSignIn|useSignUp|handleSubmit|onSubmit|zodResolver" "C:/Aman/Coding-Bamzii/Web Development/Owe/app/(auth)/sign-up.tsx"

      # 4. TypeScript check on auth screens
      cd "C:/Aman/Coding-Bamzii/Web Development/Owe" && npx tsc --noEmit --skipLibCheck 2>&1 | grep -E "sign-in|sign-up|error TS" | head -20
    </automated>
  </verify>
  <done>
    - `app/(auth)/sign-in.tsx` has "Continue with Google" button with divider above the sign-up navigation link; warmUpAsync/coolDownAsync in useEffect; Linking.useURL() cold-start handler; all existing sign-in logic unchanged
    - `app/(auth)/sign-up.tsx` has identical Google button additions; all existing sign-up logic unchanged
    - No TypeScript errors in either screen
    - `variant="secondary"` used (not `"outline"` — the Button component does not support that variant)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Task 1 installed expo-auth-session + expo-web-browser + expo-crypto, added useSignInWithGoogle hook and createSessionFromUrl to hooks.ts, and wrote the DB migration that patches handle_new_user for Google OAuth metadata.

    Task 2 wired the Google button, divider, WebBrowser warmup, and cold-start Linking handler into both sign-in and sign-up screens.

    The Supabase redirect allowlist step (adding nexus://** to Supabase Auth → URL Configuration → Redirect URLs) must be completed before the OAuth flow will work.
  </what-built>
  <how-to-verify>
    **Step 0 — Required dashboard action before testing:**
    1. Go to Supabase Dashboard → Auth → URL Configuration → Redirect URLs
    2. Add `nexus://**` to the allowlist (the wildcard covers any path makeRedirectUri() appends)
    3. Save changes

    **Step 1 — Build and launch the dev client:**
    ```bash
    # If you already have the dev client installed on your Android device/emulator, just run:
    npx expo start --dev-client
    # Then open the Owe dev client and navigate to the sign-in screen
    ```

    **Step 2 — Test Google OAuth on sign-in screen:**
    1. On the sign-in screen, verify a "Continue with Google" button appears below the "Sign in" button, separated by an "or" divider
    2. Tap "Continue with Google" — the system browser (Chrome on Android) should open to Google's sign-in page
    3. Complete the Google sign-in with a Google account
    4. Verify you land on the app dashboard (same as email/password sign-in)
    5. Verify your display name and avatar appear correctly on the profile screen

    **Step 3 — Test Google OAuth on sign-up screen:**
    1. Sign out, go to the sign-up screen
    2. Verify "Continue with Google" button appears there too
    3. Use a different Google account (one not previously used) — should create a new account and land on dashboard

    **Step 4 — Test account linking (AUTH-07):**
    1. Sign out
    2. On sign-in screen, tap "Continue with Google" with an account whose email matches an existing email/password user
    3. Verify you land on the dashboard AS THE SAME USER — same groups, same profile data — not a new duplicate account

    **Step 5 — Regression test existing email/password flow:**
    1. Sign out, sign back in with email + password — verify it still works normally
    2. Create a new account with email + password — verify it still works normally

    **Expected Google button appearance:** Dark surface background with border (secondary variant) — visually distinct from the primary neon "Sign in" button above it.

    **If the browser returns type: "cancel" instead of opening Google:** The redirect URL is not registered in Supabase. Repeat Step 0.
    **If Google shows redirect_uri_mismatch:** Google Cloud Console needs `https://<project-ref>.supabase.co/auth/v1/callback` in Authorized Redirect URIs (this was noted as already configured per planning context).
  </how-to-verify>
  <resume-signal>Type "approved" if all flows work, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
## Phase 1.5 Completion Checks

**AUTH-06 (Google OAuth sign-in/sign-up):**
- "Continue with Google" button present on both auth screens
- `useSignInWithGoogle` uses `signInWithOAuth({ provider: 'google', skipBrowserRedirect: true })` + `WebBrowser.openAuthSessionAsync`
- `createSessionFromUrl` extracts tokens and calls `supabase.auth.setSession`
- `onAuthStateChange` in existing `useSession` fires automatically, routing to `(app)` stack

**AUTH-07 (automatic account linking):**
- No client code required — handled server-side by Supabase automatic identity linking
- Verified via human checkpoint: same-email Google sign-in routes to existing account, not a duplicate

**DB trigger (new OAuth user profile population):**
- Migration `20260228000002_google_oauth.sql` uses `CREATE OR REPLACE` — preserves trigger binding
- COALESCE handles both `display_name` (email/password) and `full_name` (Google OAuth) keys
- `avatar_url` populated from Google metadata for new OAuth users

**Regression (existing auth):**
- All 6 existing auth hooks untouched in hooks.ts
- All existing form logic in sign-in.tsx and sign-up.tsx untouched
- TypeScript compilation passes with no new errors
</verification>

<success_criteria>
- User can authenticate via Google OAuth from sign-in OR sign-up screen and land on the dashboard
- Same-email Google sign-in links to existing account — no duplicate user (AUTH-07)
- Brand-new Google users have display_name (from Google's full_name) and avatar_url populated in profiles table
- Cold-start Android deep link handled via Linking.useURL() — OAuth works even if Chrome cold-starts the app
- All existing email/password flows work identically to before — zero regressions
- TypeScript compilation clean
</success_criteria>

<output>
After completion, create `.planning/phases/1.5-google-oauth-inserted/1.5-01-SUMMARY.md` following the summary template at `@./.claude/get-shit-done/templates/summary.md`.
</output>
